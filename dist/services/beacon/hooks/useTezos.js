'use strict';var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){function adopt(value){return value instanceof P?value:new P(function(resolve){resolve(value);});}return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value));}catch(e){reject(e);}}function rejected(value){try{step(generator['throw'](value));}catch(e){reject(e);}}function step(result){result.done?resolve(result.value):adopt(result.value).then(fulfilled,rejected);}step((generator=generator.apply(thisArg,_arguments||[])).next());});};var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{'default':mod};};Object.defineProperty(exports,'__esModule',{value:true});exports.useTezos=exports.initTezosInstance=void 0;const react_query_1=require('react-query');const react_1=require('react');const taquito_1=require('@taquito/taquito');const beacon_1=require('../../beacon');const context_1=require('../context');const tzip16_1=require('@taquito/tzip16');const mixpanel_browser_1=__importDefault(require('mixpanel-browser'));const initTezosInstance=network=>{const newTezos=new taquito_1.TezosToolkit(beacon_1.rpcNodes[network]);newTezos.setPackerProvider(new taquito_1.MichelCodecPacker());newTezos.addExtension(new tzip16_1.Tzip16Module());return newTezos;};exports.initTezosInstance=initTezosInstance;const useTezos=()=>{const {state:{tezos,network,account,wallet},dispatch}=(0,react_1.useContext)(context_1.TezosContext);const queryClient=(0,react_query_1.useQueryClient)();const connect=(0,react_1.useCallback)(newNetwork=>__awaiter(void 0,void 0,void 0,function*(){const {wallet}=yield(0,beacon_1.connectWithBeacon)(network);const newTezos=(0,exports.initTezosInstance)(network||newNetwork);newTezos.setProvider({wallet});const account=yield newTezos.wallet.pkh();dispatch({type:beacon_1.TezosActionType.UPDATE_TEZOS,payload:{network:newNetwork||network,tezos:newTezos,account,wallet}});mixpanel_browser_1.default.identify(account);return newTezos;}),[dispatch,network]);return{tezos,connect,reset:(0,react_1.useCallback)(()=>__awaiter(void 0,void 0,void 0,function*(){if(!wallet){throw new Error('No Wallet Connected');}yield wallet.disconnect();dispatch({type:beacon_1.TezosActionType.RESET_TEZOS});}),[dispatch,wallet]),changeNetwork:newNetwork=>__awaiter(void 0,void 0,void 0,function*(){mixpanel_browser_1.default.register({Network:newNetwork});localStorage.setItem('homebase:network',newNetwork);if(!('_pkh'in tezos.wallet)){const Tezos=new taquito_1.TezosToolkit(beacon_1.rpcNodes[newNetwork]);Tezos.setPackerProvider(new taquito_1.MichelCodecPacker());Tezos.addExtension(new tzip16_1.Tzip16Module());dispatch({type:beacon_1.TezosActionType.UPDATE_TEZOS,payload:{network:newNetwork,tezos:Tezos,account,wallet:undefined}});}else{yield connect(newNetwork);}queryClient.resetQueries();location.reload();}),account,network,wallet};};exports.useTezos=useTezos;