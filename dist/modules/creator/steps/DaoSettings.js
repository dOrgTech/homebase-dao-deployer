'use strict';Object.defineProperty(exports,'__esModule',{value:true});exports.DaoSettings=void 0;const jsx_runtime_1=require('react/jsx-runtime');const core_1=require('@material-ui/core');const utils_1=require('@taquito/utils');const react_1=require('react');const react_router_1=require('react-router');const react_router_dom_1=require('react-router-dom');const formik_1=require('formik');const formik_material_ui_1=require('formik-material-ui');const TitleBlock_1=require('../../common/TitleBlock');const state_1=require('../state');const icons_1=require('@material-ui/icons');const useTokenMetadata_1=require('../../../services/contracts/baseDAO/hooks/useTokenMetadata');const useTezos_1=require('../../../services/beacon/hooks/useTezos');const SecondContainer=(0,core_1.styled)(core_1.Grid)({marginTop:25});const CustomInputContainer=(0,core_1.styled)(core_1.Grid)(({theme})=>({height:54,boxSizing:'border-box',marginTop:14,background:'#2F3438',borderRadius:8,alignItems:'center',display:'flex',padding:'13px 23px'}));const InfoIcon=(0,core_1.styled)(icons_1.InfoRounded)(({theme})=>({position:'absolute',right:25,top:'20%',color:theme.palette.secondary.light,height:18,width:18}));const InfoIconInput=(0,core_1.styled)(icons_1.InfoRounded)(({theme})=>({cursor:'default',color:theme.palette.secondary.light,height:16,width:16}));const TextareaContainer=(0,core_1.styled)(core_1.Grid)({display:'flex',position:'relative'});const CustomFormikTextField=(0,core_1.withStyles)({root:{'& .MuiInput-root':{fontWeight:300,textAlign:'initial'},'& .MuiInputBase-input':{textAlign:'initial'},'& .MuiInput-underline:before':{borderBottom:'none !important'},'& .MuiInput-underline:hover:before':{borderBottom:'none !important'},'& .MuiInput-underline:after':{borderBottom:'none !important'}}})(formik_material_ui_1.TextField);const MetadataContainer=(0,core_1.styled)(core_1.Grid)({margin:'-4px 0 16px 0'});const CustomTextarea=(0,core_1.styled)((0,core_1.withTheme)(core_1.TextareaAutosize))(props=>({'minHeight':152,'boxSizing':'border-box','width':'100%','marginTop':14,'fontWeight':300,'padding':'21px 20px','fontFamily':'system-ui','border':'none','fontSize':16,'color':props.theme.palette.text.secondary,'background':'#2F3438','borderRadius':8,'paddingRight':40,'wordBreak':'break-word','&:focus-visible':{outline:'none'}}));const ErrorText=(0,core_1.styled)(core_1.Typography)({fontSize:14,color:'red'});const DaoSettingsForm=(0,react_router_1.withRouter)(({submitForm,values,setFieldValue,errors,touched,setFieldTouched})=>{var _a,_b,_c,_d,_e,_f,_g,_h;const theme=(0,core_1.useTheme)();const isMobile=(0,core_1.useMediaQuery)(theme.breakpoints.down('md'));const {data:tokenMetadata,isLoading:loading,error}=(0,useTokenMetadata_1.useTokenMetadata)((_a=values===null||values===void 0?void 0:values.governanceToken)===null||_a===void 0?void 0:_a.address,(_b=values===null||values===void 0?void 0:values.governanceToken)===null||_b===void 0?void 0:_b.tokenId);(0,react_1.useEffect)(()=>{if(tokenMetadata){setFieldValue('governanceToken.tokenMetadata',tokenMetadata);setFieldValue('symbol',tokenMetadata.symbol);}if(error){setFieldValue('governanceToken.tokenMetadata',undefined);setFieldValue('symbol',undefined);}},[error,setFieldValue,tokenMetadata]);const {dispatch}=(0,react_1.useContext)(state_1.CreatorContext);const match=(0,react_router_dom_1.useRouteMatch)();const history=(0,react_router_1.useHistory)();(0,react_1.useEffect)(()=>{if(values){dispatch({type:state_1.ActionTypes.UPDATE_NAVIGATION_BAR,next:{handler:()=>{submitForm(values);},text:'Continue'},back:{handler:()=>history.push(`template`),text:'Back'}});}},[dispatch,errors,history,match.path,match.url,submitForm,values]);return(0,jsx_runtime_1.jsxs)(jsx_runtime_1.Fragment,{children:[(0,jsx_runtime_1.jsxs)(SecondContainer,{container:true,item:true,direction:'row',spacing:2,wrap:'wrap',children:[(0,jsx_runtime_1.jsxs)(core_1.Grid,{item:true,xs:isMobile?12:9,children:[(0,jsx_runtime_1.jsxs)(core_1.Typography,{variant:'subtitle1',color:'textSecondary',children:[' ','Token Address',' ']}),(0,jsx_runtime_1.jsx)(CustomInputContainer,{children:(0,jsx_runtime_1.jsx)(formik_1.Field,{id:'outlined-basic',placeholder:'KT1....',name:'governanceToken.address',component:CustomFormikTextField,onClick:()=>setFieldTouched('governanceToken.address'),inputProps:{maxLength:36}})}),((_c=errors.governanceToken)===null||_c===void 0?void 0:_c.address)&&((_d=touched.governanceToken)===null||_d===void 0?void 0:_d.address)?(0,jsx_runtime_1.jsx)(ErrorText,{children:(_e=errors.governanceToken)===null||_e===void 0?void 0:_e.address}):null]}),(0,jsx_runtime_1.jsxs)(core_1.Grid,{item:true,xs:isMobile?12:3,children:[(0,jsx_runtime_1.jsxs)(core_1.Typography,{variant:'subtitle1',color:'textSecondary',children:[' ','Token ID',' ']}),(0,jsx_runtime_1.jsx)(CustomInputContainer,{children:(0,jsx_runtime_1.jsx)(formik_1.Field,{id:'outlined-basic',placeholder:'0',name:'governanceToken.tokenId',component:CustomFormikTextField,InputProps:{endAdornment:(0,jsx_runtime_1.jsx)(core_1.InputAdornment,{position:'start',children:(0,jsx_runtime_1.jsx)(core_1.Tooltip,{placement:'bottom',title:'Homebase will only track your governance token at a certain ID index, which is a parameter specified upon deploying the token contract. Fungible tokens usually have the ID of 0 (zero).',children:(0,jsx_runtime_1.jsx)(InfoIconInput,{})})})}})}),((_f=errors.governanceToken)===null||_f===void 0?void 0:_f.tokenId)&&((_g=touched.governanceToken)===null||_g===void 0?void 0:_g.tokenId)?(0,jsx_runtime_1.jsx)(ErrorText,{children:(_h=errors.governanceToken)===null||_h===void 0?void 0:_h.tokenId}):null]}),tokenMetadata&&!loading&&(0,jsx_runtime_1.jsx)(MetadataContainer,{item:true,xs:12,children:(0,jsx_runtime_1.jsxs)(core_1.Typography,{variant:'subtitle2',color:'secondary',children:[tokenMetadata.name,' (',tokenMetadata.symbol,')']})}),(0,jsx_runtime_1.jsxs)(core_1.Grid,{item:true,xs:isMobile?12:12,children:[(0,jsx_runtime_1.jsxs)(core_1.Typography,{variant:'subtitle1',color:'textSecondary',children:[' ','DAO Name',' ']}),(0,jsx_runtime_1.jsx)(CustomInputContainer,{children:(0,jsx_runtime_1.jsx)(formik_1.Field,{name:'name',inputProps:{maxLength:18},type:'text',placeholder:'My Group\u2019s Token',component:CustomFormikTextField})}),errors.name&&touched.name?(0,jsx_runtime_1.jsx)(ErrorText,{children:errors.name}):null]})]}),(0,jsx_runtime_1.jsxs)(SecondContainer,{container:true,direction:'row',alignItems:'center',children:[(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,xs:12,children:(0,jsx_runtime_1.jsx)(core_1.Typography,{variant:'subtitle1',color:'textSecondary',children:'Description'})}),(0,jsx_runtime_1.jsxs)(TextareaContainer,{item:true,xs:12,children:[(0,jsx_runtime_1.jsx)(formik_1.Field,{name:'description',children:()=>(0,jsx_runtime_1.jsx)(CustomTextarea,{maxLength:1500,'aria-label':'empty textarea',placeholder:'This is what we\u2019re about...',value:(0,formik_1.getIn)(values,'description'),onChange:newValue=>{setFieldValue('description',newValue.target.value);}})}),(0,jsx_runtime_1.jsx)(core_1.Tooltip,{placement:'bottom',title:'Description info',children:(0,jsx_runtime_1.jsx)(InfoIcon,{})})]}),errors.description&&touched.description?(0,jsx_runtime_1.jsx)(ErrorText,{children:errors.description}):null]}),(0,jsx_runtime_1.jsxs)(SecondContainer,{item:true,container:true,direction:'row',alignItems:'center',children:[(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,xs:12,children:(0,jsx_runtime_1.jsxs)(core_1.Typography,{variant:'subtitle1',color:'textSecondary',children:[' ','Guardian',' ']})}),(0,jsx_runtime_1.jsxs)(core_1.Grid,{item:true,xs:12,children:[(0,jsx_runtime_1.jsx)(CustomInputContainer,{children:(0,jsx_runtime_1.jsx)(formik_1.Field,{name:'guardian',type:'text',placeholder:'tz1PXn....',component:CustomFormikTextField,onClick:()=>setFieldTouched('guardian'),inputProps:{maxLength:36},InputProps:{endAdornment:(0,jsx_runtime_1.jsx)(core_1.InputAdornment,{position:'start',children:(0,jsx_runtime_1.jsx)(core_1.Tooltip,{placement:'bottom',title:'Address that can drop/cancel any proposals, Should be a contract like multisig or another DAO',children:(0,jsx_runtime_1.jsx)(InfoIconInput,{color:'secondary'})})})}})}),errors.guardian&&touched.guardian?(0,jsx_runtime_1.jsx)(ErrorText,{children:errors.guardian}):null]})]})]});});const isInvalidKtOrTzAddress=address=>(0,utils_1.validateContractAddress)(address)!==3&&(0,utils_1.validateAddress)(address)!==3;const validateForm=values=>{var _a;const errors={};if(!values.name){errors.name='Required';}if(!values.symbol){errors.symbol='Required';}if(!values.description){errors.description='Required';}if(!values.guardian){errors.guardian='Required';}if(values.guardian&&isInvalidKtOrTzAddress(values.guardian)){errors.guardian='Invalid address';}if(!values.governanceToken.address){errors.governanceToken=Object.assign(Object.assign({},errors.governanceToken),{address:'Required'});}if(values.governanceToken.address&&(0,utils_1.validateContractAddress)(values.governanceToken.address)!==3){errors.governanceToken=Object.assign(Object.assign({},errors.governanceToken),{address:'Invalid address'});}if(!values.governanceToken.tokenId){errors.governanceToken=Object.assign(Object.assign({},errors.governanceToken),{tokenId:'Required'});}if(!values.governanceToken.tokenMetadata){errors.governanceToken=Object.assign(Object.assign({},errors.governanceToken),{address:'Could not find token'});}if(((_a=values.governanceToken.tokenMetadata)===null||_a===void 0?void 0:_a.standard)==='fa1.2'){errors.governanceToken=Object.assign(Object.assign({},errors.governanceToken),{address:'FA1.2 Tokens Not Supported'});}return errors;};const DaoSettings=()=>{const {state,dispatch,updateCache}=(0,react_1.useContext)(state_1.CreatorContext);const {orgSettings}=state.data;const history=(0,react_router_1.useHistory)();const {account}=(0,useTezos_1.useTezos)();const saveStepInfo=(values,{setSubmitting})=>{const newValues=Object.assign(Object.assign({},values),{administrator:account});const newState=Object.assign(Object.assign({},state.data),{orgSettings:newValues});updateCache(newState);setSubmitting(true);dispatch({type:state_1.ActionTypes.UPDATE_ORGANIZATION_SETTINGS,org:newValues});history.push(`voting`);};return(0,jsx_runtime_1.jsxs)(core_1.Box,{children:[(0,jsx_runtime_1.jsx)(TitleBlock_1.TitleBlock,{title:'DAO Settings',description:(0,jsx_runtime_1.jsxs)(core_1.Typography,{variant:'subtitle1',color:'textSecondary',children:['These settings will define the name, symbol, and initial distribution of your token. You will need a pre-existing FA2 token to use as governance token. To deploy your own governance token you can go',' ',(0,jsx_runtime_1.jsx)(core_1.Link,{target:'_blank',href:'https://fa2-bakery.netlify.app/',color:'secondary',children:'here'}),' ','and then come back.']})}),(0,jsx_runtime_1.jsx)(formik_1.Formik,{enableReinitialize:true,validateOnChange:true,validateOnBlur:true,validate:validateForm,onSubmit:saveStepInfo,initialValues:orgSettings,children:({submitForm,isSubmitting,setFieldValue,values,errors,touched,setFieldTouched})=>{return(0,jsx_runtime_1.jsx)(formik_1.Form,{style:{width:'100%'},children:(0,jsx_runtime_1.jsx)(DaoSettingsForm,{submitForm:submitForm,isSubmitting:isSubmitting,setFieldValue:setFieldValue,errors:errors,touched:touched,values:values,setFieldTouched:setFieldTouched})});}})]});};exports.DaoSettings=DaoSettings;