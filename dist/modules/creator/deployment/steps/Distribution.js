'use strict';var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{'default':mod};};Object.defineProperty(exports,'__esModule',{value:true});exports.ContractDistribution=void 0;const jsx_runtime_1=require('react/jsx-runtime');const core_1=require('@material-ui/core');const formik_1=require('formik');const react_1=require('react');const react_router_dom_1=require('react-router-dom');const context_1=require('../state/context');const types_1=require('../state/types');const formik_material_ui_1=require('formik-material-ui');const icons_1=require('@material-ui/icons');const bignumber_js_1=__importDefault(require('bignumber.js'));const utils_1=require('../state/utils');const TitleBlock_1=require('../../../common/TitleBlock');const useTezos_1=require('../../../../services/beacon/hooks/useTezos');const utils_2=require('../../utils');const SupplyContainer=(0,core_1.styled)(core_1.Grid)(({theme})=>({background:theme.palette.primary.dark,padding:'30px 40px',borderRadius:8}));const RemoveButton=(0,core_1.styled)(icons_1.RemoveCircle)({marginTop:13});const AmountText=(0,core_1.styled)(core_1.Typography)({fontWeight:200});const ButtonContainer=(0,core_1.styled)(core_1.Grid)({marginTop:40});const CustomFormikTextField=(0,core_1.withStyles)({root:{'& .MuiInput-root':{fontWeight:300,textAlign:'initial'},'& .MuiInputBase-input':{textAlign:'initial'},'& .MuiInput-underline:before':{borderBottom:'none !important'},'& .MuiInput-underline:hover:before':{borderBottom:'none !important'},'& .MuiInput-underline:after':{borderBottom:'none !important'}}})(formik_material_ui_1.TextField);const CustomInputContainer=(0,core_1.styled)(core_1.Grid)(({theme})=>({height:54,boxSizing:'border-box',marginTop:14,background:'#2F3438',borderRadius:8,alignItems:'center',display:'flex',padding:'13px 23px',width:'100%'}));const CustomAmountContainer=(0,core_1.styled)(core_1.Grid)(({theme})=>({height:54,boxSizing:'border-box',marginTop:14,background:'#2F3438',borderRadius:8,alignItems:'center',display:'flex',padding:'13px 23px',width:'40%',[theme.breakpoints.down('sm')]:{width:'100%'}}));const ErrorText=(0,core_1.styled)(core_1.Typography)({fontSize:14,color:'red'});const hasDuplicates=options=>{const trimOptions=options.map(option=>option.walletAddress.trim());return new Set(trimOptions).size!==trimOptions.length;};const validateForm=values=>{const errors={};values.holders.forEach((holder,index)=>{if(values.holders[index].walletAddress&&!values.holders[index].amount){errors.holders='Required';}if(!values.holders[index].walletAddress&&values.holders[index].amount){errors.holders='Required';}if(values.holders.length>0&&hasDuplicates(values.holders)){errors.holders='Duplicate wallets are not allowed';}if(values.totalAmount&&values.totalAmount.minus(new bignumber_js_1.default(getTotal(values.holders)))<new bignumber_js_1.default(0)){errors.totalAmount='Available balance has to be greater that the total supply';}});return errors;};const TokenSettingsForm=({submitForm,values,errors,touched,setFieldValue,setFieldTouched})=>{const theme=(0,core_1.useTheme)();const isMobile=(0,core_1.useMediaQuery)(theme.breakpoints.down('sm'));const newValue={walletAddress:'',amount:null};const {dispatch}=(0,react_1.useContext)(context_1.DeploymentContext);const match=(0,react_router_dom_1.useRouteMatch)();const history=(0,react_router_dom_1.useHistory)();(0,react_1.useEffect)(()=>{if(values){dispatch({type:types_1.ActionTypes.UPDATE_NAVIGATION_BAR,next:{text:'Continue',handler:()=>{submitForm(values);}},back:{text:'Back',handler:()=>history.push(`config`)}});}},[dispatch,errors,history,match.path,match.url,submitForm,values]);return(0,jsx_runtime_1.jsx)(jsx_runtime_1.Fragment,{children:(0,jsx_runtime_1.jsx)(core_1.Grid,{container:true,direction:'column',children:(0,jsx_runtime_1.jsx)(formik_1.FieldArray,{name:'holders',render:arrayHelpers=>(0,jsx_runtime_1.jsxs)('div',{children:[values.holders&&values.holders.length>0?values.holders.map((holder,index)=>(0,jsx_runtime_1.jsxs)('div',{style:isMobile?{display:'inline-block',gap:16,alignItems:'center'}:{display:'flex',gap:16,alignItems:'center'},children:[(0,jsx_runtime_1.jsx)(CustomInputContainer,{children:(0,jsx_runtime_1.jsx)(formik_1.Field,{type:'text',name:`holders.[${index}].walletAddress`,placeholder:`Wallet address`,component:CustomFormikTextField})}),(0,jsx_runtime_1.jsx)(CustomAmountContainer,{children:(0,jsx_runtime_1.jsx)(formik_1.Field,{type:'number',name:`holders.[${index}].amount`,placeholder:`Amount`,component:CustomFormikTextField,onKeyDown:e=>(0,utils_2.handleNegativeInput)(e)})}),index!==0?(0,jsx_runtime_1.jsx)(RemoveButton,{color:'error',onClick:()=>{if(index!==0){arrayHelpers.remove(index);}}}):(0,jsx_runtime_1.jsx)(RemoveButton,{color:'error',style:{visibility:'hidden'}})]},index)):null,errors.holders&&touched.holders?(0,jsx_runtime_1.jsx)(ErrorText,{children:errors.holders}):null,(0,jsx_runtime_1.jsx)('div',{children:(0,jsx_runtime_1.jsxs)(core_1.Grid,{container:true,alignItems:'center',style:{gap:10},children:[(0,jsx_runtime_1.jsx)(core_1.IconButton,{size:'small',style:{cursor:'pointer'},onClick:()=>arrayHelpers.insert(values.holders.length,newValue),children:(0,jsx_runtime_1.jsx)(icons_1.AddCircleOutline,{htmlColor:theme.palette.secondary.main})}),(0,jsx_runtime_1.jsx)(core_1.Typography,{variant:'body2',style:{cursor:'pointer'},onClick:()=>arrayHelpers.insert(values.holders.length,newValue),color:'secondary',children:'Add Member'})]})})]})})})});};const getTotal=holders=>{let total=0;holders.forEach(holder=>total+=Number(holder.amount));return total;};const ContractDistribution=()=>{const {state,dispatch,updateCache}=(0,react_1.useContext)(context_1.DeploymentContext);const {tokenDistribution,tokenSettings}=state.data;const history=(0,react_router_dom_1.useHistory)();const {account}=(0,useTezos_1.useTezos)();const theme=(0,core_1.useTheme)();const isMobile=(0,core_1.useMediaQuery)(theme.breakpoints.down('sm'));tokenDistribution.totalAmount=new bignumber_js_1.default(Number(tokenSettings.totalSupply));const saveStepInfo=(values,{setSubmitting})=>{const newValues=Object.assign({},values);if(newValues.holders.length===1&&newValues.holders[0].walletAddress===''){newValues.holders[0].walletAddress=account;newValues.holders[0].amount=newValues.totalAmount.toNumber();}const newState=Object.assign(Object.assign({},state.data),{tokenDistribution:newValues});updateCache(newState);setSubmitting(true);dispatch({type:types_1.ActionTypes.UPDATE_TOKEN_DISTRIBUTION,distribution:newValues});history.push(`summary`);};return(0,jsx_runtime_1.jsx)(jsx_runtime_1.Fragment,{children:(0,jsx_runtime_1.jsx)(core_1.Grid,{container:true,direction:'column',children:(0,jsx_runtime_1.jsx)(formik_1.Formik,{enableReinitialize:true,validateOnChange:true,validateOnBlur:false,validate:validateForm,onSubmit:saveStepInfo,initialValues:tokenDistribution,children:({submitForm,isSubmitting,setFieldValue,values,errors,touched,setFieldTouched})=>{return(0,jsx_runtime_1.jsxs)(formik_1.Form,{style:{width:'100%'},children:[(0,jsx_runtime_1.jsx)(core_1.Grid,{children:(0,jsx_runtime_1.jsx)(TitleBlock_1.TitleBlock,{title:'Initial token distribution',description:''})}),(0,jsx_runtime_1.jsxs)(SupplyContainer,{item:true,container:true,direction:'column',style:{gap:'12px'},children:[(0,jsx_runtime_1.jsxs)(core_1.Grid,{container:true,item:true,direction:'row',style:{gap:10},children:[(0,jsx_runtime_1.jsx)(AmountText,{color:'textSecondary',children:'Total supply: '}),(0,jsx_runtime_1.jsxs)(core_1.Typography,{color:'secondary',children:[' ',(0,utils_1.numberWithCommas)(values.totalAmount),' ']})]}),(0,jsx_runtime_1.jsxs)(core_1.Grid,{container:true,item:true,direction:'row',style:{gap:10},children:[(0,jsx_runtime_1.jsx)(AmountText,{color:'textSecondary',children:'Available:'}),(0,jsx_runtime_1.jsxs)(core_1.Typography,{color:'secondary',children:[' ',(0,utils_1.numberWithCommas)(values.totalAmount&&values.totalAmount.minus(new bignumber_js_1.default(getTotal(values.holders))))]})]})]}),errors.totalAmount&&touched.totalAmount?(0,jsx_runtime_1.jsx)(ErrorText,{style:{marginTop:6},children:errors.totalAmount}):null,(0,jsx_runtime_1.jsxs)(core_1.Grid,{container:true,direction:isMobile?'column':'row',alignItems:isMobile?'flex-start':'center',style:{marginTop:35},children:[(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,xs:6,children:(0,jsx_runtime_1.jsx)(core_1.Typography,{color:'textSecondary',children:'Wallet address'})}),(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,xs:6,children:(0,jsx_runtime_1.jsx)(core_1.Typography,{color:'textSecondary',children:'Amount'})})]}),(0,jsx_runtime_1.jsx)(TokenSettingsForm,{submitForm:submitForm,isSubmitting:isSubmitting,setFieldValue:setFieldValue,errors:errors,touched:touched,values:values,setFieldTouched:setFieldTouched})]});}})})});};exports.ContractDistribution=ContractDistribution;