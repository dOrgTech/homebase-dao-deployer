'use strict';var __createBinding=this&&this.__createBinding||(Object.create?function(o,m,k,k2){if(k2===undefined)k2=k;var desc=Object.getOwnPropertyDescriptor(m,k);if(!desc||('get'in desc?!m.__esModule:desc.writable||desc.configurable)){desc={enumerable:true,get:function(){return m[k];}};}Object.defineProperty(o,k2,desc);}:function(o,m,k,k2){if(k2===undefined)k2=k;o[k2]=m[k];});var __setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(o,v){Object.defineProperty(o,'default',{enumerable:true,value:v});}:function(o,v){o['default']=v;});var __importStar=this&&this.__importStar||function(mod){if(mod&&mod.__esModule)return mod;var result={};if(mod!=null)for(var k in mod)if(k!=='default'&&Object.prototype.hasOwnProperty.call(mod,k))__createBinding(result,mod,k);__setModuleDefault(result,mod);return result;};var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){function adopt(value){return value instanceof P?value:new P(function(resolve){resolve(value);});}return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value));}catch(e){reject(e);}}function rejected(value){try{step(generator['throw'](value));}catch(e){reject(e);}}function step(result){result.done?resolve(result.value):adopt(result.value).then(fulfilled,rejected);}step((generator=generator.apply(thisArg,_arguments||[])).next());});};var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{'default':mod};};Object.defineProperty(exports,'__esModule',{value:true});exports.ProposalDetails=void 0;const jsx_runtime_1=require('react/jsx-runtime');const lodash_1=__importDefault(require('lodash'));const core_1=require('@material-ui/core');const react_html_parser_1=__importDefault(require('react-html-parser'));const bignumber_js_1=require('bignumber.js');const react_customizable_progressbar_1=__importDefault(require('react-customizable-progressbar'));const StatusBadge_1=require('../../components/StatusBadge');const UserBadge_1=require('../../components/UserBadge');const VotersProgress_1=require('../../components/VotersProgress');const useCanDropProposal_1=require('../../hooks/useCanDropProposal');const react_1=require('react');const react_router_1=require('react-router');const useTopic_1=require('../../../../services/agora/hooks/useTopic');const useDropProposal_1=require('../../../../services/contracts/baseDAO/hooks/useDropProposal');const utils_1=require('../../../../services/contracts/utils');const useDAO_1=require('../../../../services/services/dao/hooks/useDAO');const useProposal_1=require('../../../../services/services/dao/hooks/useProposal');const ContentContainer_1=require('../../components/ContentContainer');const router_1=require('../DAO/router');const useVotesStats_1=require('../../hooks/useVotesStats');const FormatNumber_1=require('../../utils/FormatNumber');const HighlightedBadge_1=require('../../components/styled/HighlightedBadge');const TransferBadge_1=require('../../components/TransferBadge');const types_1=require('../../../../services/services/dao/mappers/proposal/types');const useDAOHoldings_1=require('../../../../services/contracts/baseDAO/hooks/useDAOHoldings');const VoteDialog_1=require('../../components/VoteDialog');const XTZTransferBadge_1=require('../../components/XTZTransferBadge');const InfoIcon_1=require('../../components/styled/InfoIcon');const ProposalTransferBadge_1=require('../../components/ProposalTransferBadge');const useUnstakeVotes_1=require('../../../../services/contracts/baseDAO/hooks/useUnstakeVotes');const CopyButton_1=require('../../../common/CopyButton');const ProposalFormInput_1=require('../../components/ProposalFormInput');const prismjs_1=__importStar(require('prismjs'));const CodeCollapse_1=require('../../components/CodeCollapse');const Container=(0,core_1.styled)(ContentContainer_1.ContentContainer)({padding:'36px 45px'});const HistoryItem=(0,core_1.styled)(core_1.Grid)(({theme})=>({marginTop:20,paddingBottom:12,display:'flex',height:'auto',[theme.breakpoints.down('sm')]:{width:'unset'}}));const QuorumTitle=(0,core_1.styled)(core_1.Typography)(()=>({color:'#3866F9'}));const ViewCodeButton=(0,core_1.styled)(core_1.Button)({height:31,fontSize:16});const ProgressText=(0,core_1.styled)(core_1.Typography)(({textColor})=>({color:textColor,display:'flex',alignItems:'center',position:'absolute',width:'100%',height:'100%',fontSize:16,userSelect:'none',boxShadow:'none',background:'inherit',fontFamily:'Roboto Mono',justifyContent:'center',top:0}));const DetailsText=(0,core_1.styled)(core_1.Typography)({wordBreak:'break-all'});const VoteButton=(0,core_1.styled)(core_1.Button)(({favor})=>({backgroundColor:favor?'#3FE888':'#FF486E'}));const InfoTitle=(0,core_1.styled)(core_1.Typography)({marginTop:37,fontWeight:400,fontSize:18,lineHeigh:'27px'});const InfoItem=(0,core_1.styled)(core_1.Typography)({marginTop:11,fontWeight:400,fontSize:16,lineHeight:'24px'});const InfoCopyIcon=(0,core_1.styled)(CopyButton_1.CopyButton)({'height':15,'& svg':{height:15}});const getReadableConfig=configKey=>{switch(configKey){case'frozen_extra_value':return'Proposal fee';case'slash_scale_value':return'Percentage of tokens returned after rejection';default:return'Unknown Config parameter';}};const ProposalDetails=()=>{var _a;const {proposalId}=(0,react_router_1.useParams)();const daoId=(0,router_1.useDAOID)();const [openVote,setOpenVote]=(0,react_1.useState)(false);const [voteIsSupport,setVoteIsSupport]=(0,react_1.useState)(false);const theme=(0,core_1.useTheme)();const {data:proposal}=(0,useProposal_1.useProposal)(daoId,proposalId);const {data:dao,cycleInfo}=(0,useDAO_1.useDAO)(daoId);const isMobileSmall=(0,core_1.useMediaQuery)(theme.breakpoints.down('sm'));const {mutate:dropProposal}=(0,useDropProposal_1.useDropProposal)();const {data:holdings}=(0,useDAOHoldings_1.useDAOHoldings)(daoId);const canDropProposal=(0,useCanDropProposal_1.useCanDropProposal)(daoId,proposalId);const {data:agoraPost}=(0,useTopic_1.useAgoraTopic)(Number((_a=proposal===null||proposal===void 0?void 0:proposal.metadata)===null||_a===void 0?void 0:_a.agoraPostId));const quorumThreshold=(proposal===null||proposal===void 0?void 0:proposal.quorumThreshold)||new bignumber_js_1.BigNumber(0);const {mutate:mutateUnstake}=(0,useUnstakeVotes_1.useUnstakeVotes)();const onClickVote=support=>{setVoteIsSupport(support);setOpenVote(true);};const onCloseVote=()=>{setOpenVote(false);};const onDropProposal=(0,react_1.useCallback)(()=>__awaiter(void 0,void 0,void 0,function*(){yield dropProposal({dao:dao,proposalId});}),[dao,dropProposal,proposalId]);const onUnstakeVotes=(0,react_1.useCallback)(()=>__awaiter(void 0,void 0,void 0,function*(){yield mutateUnstake({dao:dao,proposalId});}),[dao,mutateUnstake,proposalId]);const proposalCycle=proposal?proposal.period:'-';const {votesQuorumPercentage}=(0,useVotesStats_1.useVotesStats)({upVotes:(proposal===null||proposal===void 0?void 0:proposal.upVotes)||new bignumber_js_1.BigNumber(0),downVotes:(proposal===null||proposal===void 0?void 0:proposal.downVotes)||new bignumber_js_1.BigNumber(0),quorumThreshold});const list=(0,react_1.useMemo)(()=>{if(!proposal||!(proposal instanceof types_1.LambdaProposal)){return[];}return proposal.metadata.list;},[proposal]);const transfers=(0,react_1.useMemo)(()=>{if(!holdings||!proposal){return[];}return proposal.metadata.transfers;},[holdings,proposal]);const canVote=cycleInfo&&(proposal===null||proposal===void 0?void 0:proposal.getStatus(cycleInfo.currentLevel).status)===types_1.ProposalStatus.ACTIVE;const parseReadableConfigValue=(configKey,value)=>{if(dao&&value){switch(configKey){case'frozen_extra_value':return(0,utils_1.parseUnits)(value,dao.data.token.decimals).toString();case'slash_scale_value':return 100-value.toNumber();default:return value.toString();}}};return(0,jsx_runtime_1.jsxs)(jsx_runtime_1.Fragment,{children:[(0,jsx_runtime_1.jsxs)(core_1.Grid,{container:true,direction:'column',style:{gap:42},children:[(0,jsx_runtime_1.jsx)(Container,{item:true,children:(0,jsx_runtime_1.jsxs)(core_1.Grid,{container:true,direction:'column',style:{gap:18},children:[(0,jsx_runtime_1.jsxs)(core_1.Grid,{item:true,container:true,style:{gap:21},children:[(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,children:(0,jsx_runtime_1.jsx)(core_1.Typography,{variant:'h3',color:'textPrimary',align:isMobileSmall?'center':'left',children:agoraPost?agoraPost.title:`Proposal ${(0,utils_1.toShortAddress)((proposal===null||proposal===void 0?void 0:proposal.id)||'')}`})}),(0,jsx_runtime_1.jsxs)(core_1.Grid,{children:[(0,jsx_runtime_1.jsx)(core_1.Button,{variant:'contained',color:'secondary',disabled:!canDropProposal,onClick:onDropProposal,children:'Drop Proposal'}),(0,jsx_runtime_1.jsx)(core_1.Tooltip,{placement:'bottom',title:'Guardian and proposer may drop proposal at anytime. Anyone may drop proposal if proposal expired',children:(0,jsx_runtime_1.jsx)(InfoIcon_1.InfoIcon,{color:'secondary'})})]})]}),(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,children:(0,jsx_runtime_1.jsxs)(core_1.Grid,{container:true,justifyContent:'space-between',alignItems:'center',children:[(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,children:proposal&&cycleInfo&&(0,jsx_runtime_1.jsxs)(core_1.Grid,{container:true,style:{gap:20},children:[(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,children:(0,jsx_runtime_1.jsx)(StatusBadge_1.StatusBadge,{status:proposal.getStatus(cycleInfo.currentLevel).status})}),(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,children:(0,jsx_runtime_1.jsx)(core_1.Typography,{color:'textPrimary',variant:'subtitle2',children:'CREATED BY'})}),(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,children:(0,jsx_runtime_1.jsx)(UserBadge_1.UserBadge,{address:proposal.proposer,short:true})})]})}),(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,children:(0,jsx_runtime_1.jsxs)(core_1.Grid,{container:true,style:{gap:28},children:[(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,children:(0,jsx_runtime_1.jsx)(VoteButton,{variant:'contained',favor:true,onClick:()=>onClickVote(true),disabled:!canVote,children:'Vote For'})}),(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,children:(0,jsx_runtime_1.jsx)(VoteButton,{variant:'contained',favor:false,onClick:()=>onClickVote(false),disabled:!canVote,children:'Vote Against'})})]})})]})})]})}),(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,children:(0,jsx_runtime_1.jsxs)(core_1.Grid,{container:true,style:{gap:45},children:[(0,jsx_runtime_1.jsx)(Container,{item:true,xs:12,md:7,children:(0,jsx_runtime_1.jsxs)(core_1.Grid,{container:true,direction:'column',style:{gap:18},children:[(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,children:(0,jsx_runtime_1.jsxs)(core_1.Grid,{container:true,style:{gap:18},children:[(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,children:(0,jsx_runtime_1.jsx)(core_1.Typography,{color:'secondary',children:'Votes'})}),(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,children:(0,jsx_runtime_1.jsxs)(core_1.Typography,{color:'textPrimary',children:['Cycle: ',proposalCycle]})})]})}),(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,children:(0,jsx_runtime_1.jsx)(VotersProgress_1.VotersProgress,{showButton:true,daoId:daoId,proposalId:proposalId})})]})}),(0,jsx_runtime_1.jsx)(Container,{item:true,xs:true,children:(0,jsx_runtime_1.jsxs)(core_1.Grid,{container:true,direction:'row',style:{height:'100%'},alignItems:'center',wrap:'nowrap',children:[(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,children:(0,jsx_runtime_1.jsx)(react_customizable_progressbar_1.default,{progress:proposal?votesQuorumPercentage.toNumber():0,radius:50,strokeWidth:7,strokeColor:'#3866F9',trackStrokeWidth:4,trackStrokeColor:theme.palette.primary.light,children:(0,jsx_runtime_1.jsx)('div',{className:'indicator',children:(0,jsx_runtime_1.jsx)(ProgressText,{textColor:'#3866F9',children:proposal?`${(0,FormatNumber_1.formatNumber)(votesQuorumPercentage)}%`:'-'})})})}),(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,children:(0,jsx_runtime_1.jsxs)(core_1.Grid,{container:true,direction:'column',alignItems:'flex-start',justifyContent:'center',wrap:'nowrap',style:{height:'100%'},children:[(0,jsx_runtime_1.jsxs)(core_1.Grid,{item:true,children:[proposal&&(0,jsx_runtime_1.jsx)(core_1.Tooltip,{placement:'bottom',title:`Amount of ${dao===null||dao===void 0?void 0:dao.data.token.symbol} required to be locked through voting for a proposal to be passed/rejected. ${proposal.upVotes.gte(proposal.downVotes)?proposal.upVotes.toString():proposal.downVotes.toString()}/${quorumThreshold} votes.`,children:(0,jsx_runtime_1.jsx)(InfoIcon_1.InfoIcon,{color:'secondary'})}),(0,jsx_runtime_1.jsx)(QuorumTitle,{color:'textPrimary',children:'Quorum Threshold:'})]}),(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,children:(0,jsx_runtime_1.jsx)(core_1.Typography,{color:'textPrimary',children:proposal?quorumThreshold.toString():'-'})})]})})]})})]})}),(0,jsx_runtime_1.jsx)(Container,{item:true,children:(0,jsx_runtime_1.jsxs)(core_1.Grid,{container:true,direction:'column',style:{gap:40},children:[agoraPost&&(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,children:(0,jsx_runtime_1.jsx)(core_1.Typography,{color:'textPrimary',variant:'body1',align:isMobileSmall?'center':'left',children:(0,react_html_parser_1.default)(agoraPost.post_stream.posts[0].cooked)})}),(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,container:true,style:{gap:25},children:proposal?(0,jsx_runtime_1.jsxs)(jsx_runtime_1.Fragment,{children:[proposal.metadata.lambdaType==='execute_handler'&&(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,container:true,alignItems:'center',direction:isMobileSmall?'column':'row',children:(0,jsx_runtime_1.jsx)(HighlightedBadge_1.HighlightedBadge,{justifyContent:'center',alignItems:'center',direction:'row',container:true,children:(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,children:(0,jsx_runtime_1.jsxs)(DetailsText,{variant:'body1',color:'textPrimary',children:['Execute Lambda',' ',(0,jsx_runtime_1.jsx)(core_1.Typography,{variant:'body1',color:'secondary',display:'inline',children:lodash_1.default.startCase(proposal.metadata.lambdaHandler.handler_name)}),' ']})})})}),transfers===null||transfers===void 0?void 0:transfers.map((transfer,index)=>{return(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,container:true,alignItems:'center',direction:isMobileSmall?'column':'row',children:transfer.type==='XTZ'?(0,jsx_runtime_1.jsx)(XTZTransferBadge_1.XTZTransferBadge,{amount:transfer.amount,address:transfer.beneficiary}):(0,jsx_runtime_1.jsx)(TransferBadge_1.TransferBadge,{amount:transfer.amount,address:transfer.beneficiary,contract:transfer.contractAddress,tokenId:transfer.tokenId})},index);}),proposal.metadata.config.map(({key,value},index)=>{var _a;return(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,container:true,alignItems:'center',direction:isMobileSmall?'column':'row',children:(0,jsx_runtime_1.jsx)(HighlightedBadge_1.HighlightedBadge,{justifyContent:'center',alignItems:'center',direction:'row',container:true,children:(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,children:(0,jsx_runtime_1.jsxs)(DetailsText,{variant:'body1',color:'textPrimary',children:['Change',' ',(0,jsx_runtime_1.jsx)(core_1.Typography,{variant:'body1',color:'secondary',display:'inline',children:getReadableConfig(key)}),' ','to',' ',(0,jsx_runtime_1.jsx)(core_1.Typography,{variant:'body1',color:'secondary',display:'inline',children:(_a=parseReadableConfigValue(key,value))!==null&&_a!==void 0?_a:0})]})})})},index);}),proposal.metadata.update_contract_delegate!==''&&(0,jsx_runtime_1.jsx)(ProposalTransferBadge_1.ProposalTransferBadge,{address:proposal.metadata.update_contract_delegate,label:'New Delegate'}),proposal.metadata.update_guardian!==''&&(0,jsx_runtime_1.jsx)(ProposalTransferBadge_1.ProposalTransferBadge,{address:proposal.metadata.update_guardian,label:'Update Guardian'}),list.map(({key,value},index)=>(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,container:true,alignItems:'center',direction:isMobileSmall?'column':'row',children:(0,jsx_runtime_1.jsx)(HighlightedBadge_1.HighlightedBadge,{justifyContent:'center',alignItems:'center',direction:'row',container:true,children:(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,children:(0,jsx_runtime_1.jsxs)(DetailsText,{variant:'body1',color:'textPrimary',children:['Set "',key,'" to "',value,'"']})})})},index)),(0,jsx_runtime_1.jsx)(CodeCollapse_1.CodeCollapse,{code:JSON.stringify(proposal.metadata.lambdaHandler,null,2)}),proposal.metadata.lambdaType==='add_handler'&&(0,jsx_runtime_1.jsxs)(jsx_runtime_1.Fragment,{children:[(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,container:true,alignItems:'center',direction:isMobileSmall?'column':'row',children:(0,jsx_runtime_1.jsx)(HighlightedBadge_1.HighlightedBadge,{justifyContent:'center',alignItems:'center',direction:'row',container:true,children:(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,children:(0,jsx_runtime_1.jsxs)(DetailsText,{variant:'body1',color:'textPrimary',children:['Add Lambda',' ',(0,jsx_runtime_1.jsx)(core_1.Typography,{variant:'body1',color:'secondary',display:'inline',children:proposal.metadata.lambdaHandler.name}),' ']})})})}),(0,jsx_runtime_1.jsx)(ProposalFormInput_1.ProposalCodeEditorInput,{label:'Lambda Code',containerstyle:{marginTop:'8px'},insertSpaces:true,ignoreTabKey:false,tabSize:4,padding:10,style:{minHeight:500,fontFamily:'Roboto Mono',fontSize:14,fontWeight:400,outlineWidth:0},value:JSON.stringify(proposal.metadata.lambdaHandler,null,2),onValueChange:code=>true,highlight:code=>(0,prismjs_1.highlight)(code,prismjs_1.default.languages.javascript,'javascript'),title:lodash_1.default.startCase(proposal.metadata.lambdaType)})]}),proposal.metadata.lambdaType==='remove_handler'&&(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,container:true,alignItems:'center',direction:isMobileSmall?'column':'row',children:(0,jsx_runtime_1.jsx)(HighlightedBadge_1.HighlightedBadge,{justifyContent:'center',alignItems:'center',direction:'row',container:true,children:(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,children:(0,jsx_runtime_1.jsxs)(DetailsText,{variant:'body1',color:'textPrimary',children:['Remove Lambda',' ',(0,jsx_runtime_1.jsx)(core_1.Typography,{variant:'body1',color:'secondary',display:'inline',children:lodash_1.default.startCase(proposal.metadata.lambdaHandler)}),' ']})})})})]}):null})]})}),(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,children:(0,jsx_runtime_1.jsx)(core_1.Grid,{container:true,children:(0,jsx_runtime_1.jsx)(Container,{item:true,md:12,xs:12,children:cycleInfo&&(proposal===null||proposal===void 0?void 0:proposal.getStatus(cycleInfo.currentLevel).statusHistory.map((item,index)=>{return(0,jsx_runtime_1.jsxs)(HistoryItem,{container:true,direction:'row',alignItems:'baseline',wrap:'nowrap',xs:12,style:{gap:32},children:[(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,children:(0,jsx_runtime_1.jsx)(StatusBadge_1.StatusBadge,{item:true,status:item.status})}),(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,children:(0,jsx_runtime_1.jsx)(core_1.Typography,{color:'textPrimary',variant:'subtitle2',children:item.timestamp})})]},index);}))})})})]}),(0,jsx_runtime_1.jsx)(VoteDialog_1.VoteDialog,{open:openVote,support:voteIsSupport,onClose:onCloseVote})]});};exports.ProposalDetails=ProposalDetails;