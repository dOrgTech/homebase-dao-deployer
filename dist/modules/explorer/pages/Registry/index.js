'use strict';Object.defineProperty(exports,'__esModule',{value:true});exports.Registry=void 0;const jsx_runtime_1=require('react/jsx-runtime');const core_1=require('@material-ui/core');const CopyAddress_1=require('../../../common/CopyAddress');const ProposalForm_1=require('../../components/ProposalForm');const react_1=require('react');const useDAO_1=require('../../../../services/services/dao/hooks/useDAO');const useProposals_1=require('../../../../services/services/dao/hooks/useProposals');const Hero_1=require('../../components/Hero');const HeroTitle_1=require('../../components/HeroTitle');const router_1=require('../DAO/router');const RegistryTable_1=require('./components/RegistryTable');const UpdatesTable_1=require('./components/UpdatesTable');const useCycleInfo_1=require('../../../../services/contracts/baseDAO/hooks/useCycleInfo');const InfoIcon_1=require('../../components/styled/InfoIcon');const MainButton_1=require('../../../common/MainButton');const Registry=()=>{const theme=(0,core_1.useTheme)();const isMobileSmall=(0,core_1.useMediaQuery)(theme.breakpoints.down('sm'));const daoId=(0,router_1.useDAOID)();const {data:dao}=(0,useDAO_1.useDAO)(daoId);const [updateRegistryOpen,setUpdateRegistryOpen]=(0,react_1.useState)(false);const {data:proposalsData}=(0,useProposals_1.useProposals)(daoId);const [defaultData,setDefaultData]=(0,react_1.useState)();const shouldDisable=(0,useCycleInfo_1.useIsProposalButtonDisabled)(daoId);const onCloseRegistryUpdate=()=>{setUpdateRegistryOpen(false);setDefaultData(undefined);};const proposals=(0,react_1.useMemo)(()=>{if(!proposalsData||!dao){return[];}const registryDAO=dao;const registryProposalsData=proposalsData;const registryAffectedKeysProposalIds=registryDAO.decoded.decodedRegistryAffected.map(r=>r.proposalId);return registryProposalsData.filter(proposal=>registryAffectedKeysProposalIds.includes(proposal.id)).sort((a,b)=>new Date(a.startDate).getTime()-new Date(b.startDate).getTime()).map(proposal=>Object.assign(Object.assign({},proposal),{description:'Proposal description',address:proposal.id,lastUpdated:proposal.startDate,list:proposal.metadata.list,proposalId:proposal.id,agoraPostId:Number(proposal.metadata.agoraPostId)})).flatMap(proposal=>proposal.list.map(({key})=>Object.assign(Object.assign({},proposal),{key})));},[dao,proposalsData]);const onClickItem=item=>{setDefaultData({registryUpdateForm:{isBatch:false,list:[item]}});setUpdateRegistryOpen(true);};const registryList=(0,react_1.useMemo)(()=>{return dao===null||dao===void 0?void 0:dao.decoded.decodedRegistry.map(d=>{var _a;return Object.assign(Object.assign({},d),{lastUpdated:(_a=proposals.find(proposal=>proposal.key===d.key))===null||_a===void 0?void 0:_a.startDate,onClick:()=>onClickItem(d)});});},[dao,proposals]);return(0,jsx_runtime_1.jsxs)(jsx_runtime_1.Fragment,{children:[(0,jsx_runtime_1.jsxs)(core_1.Grid,{container:true,direction:'column',style:{gap:42},children:[(0,jsx_runtime_1.jsxs)(Hero_1.Hero,{children:[(0,jsx_runtime_1.jsxs)(core_1.Grid,{item:true,children:[(0,jsx_runtime_1.jsx)(HeroTitle_1.HeroTitle,{children:'Registry'}),dao&&(0,jsx_runtime_1.jsx)(CopyAddress_1.CopyAddress,{address:dao.data.address,justifyContent:isMobileSmall?'center':'flex-start',typographyProps:{variant:'subtitle2'}})]}),(0,jsx_runtime_1.jsxs)(core_1.Grid,{item:true,children:[(0,jsx_runtime_1.jsx)(MainButton_1.MainButton,{variant:'contained',color:'secondary',onClick:()=>setUpdateRegistryOpen(true),disabled:shouldDisable,children:'New Item'}),shouldDisable&&(0,jsx_runtime_1.jsx)(core_1.Tooltip,{placement:'bottom',title:'Not on proposal creation period',children:(0,jsx_runtime_1.jsx)(InfoIcon_1.InfoIcon,{color:'secondary'})})]})]}),(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,children:(0,jsx_runtime_1.jsx)(RegistryTable_1.RegistryTable,{data:registryList})}),(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,children:(0,jsx_runtime_1.jsx)(UpdatesTable_1.UpdatesTable,{data:proposals})})]}),(0,jsx_runtime_1.jsx)(ProposalForm_1.ProposalFormContainer,{open:updateRegistryOpen,handleClose:onCloseRegistryUpdate,defaultTab:2,defaultValues:defaultData})]});};exports.Registry=Registry;