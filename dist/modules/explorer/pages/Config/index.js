'use strict';var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){function adopt(value){return value instanceof P?value:new P(function(resolve){resolve(value);});}return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value));}catch(e){reject(e);}}function rejected(value){try{step(generator['throw'](value));}catch(e){reject(e);}}function step(result){result.done?resolve(result.value):adopt(result.value).then(fulfilled,rejected);}step((generator=generator.apply(thisArg,_arguments||[])).next());});};Object.defineProperty(exports,'__esModule',{value:true});exports.Config=exports.DropButton=void 0;const jsx_runtime_1=require('react/jsx-runtime');const core_1=require('@material-ui/core');const react_1=require('react');const useFlush_1=require('../../../../services/contracts/baseDAO/hooks/useFlush');const useDAO_1=require('../../../../services/services/dao/hooks/useDAO');const useProposals_1=require('../../../../services/services/dao/hooks/useProposals');const router_1=require('../DAO/router');const useDropAllExpired_1=require('../../../../services/contracts/baseDAO/hooks/useDropAllExpired');const SmallButton_1=require('../../../common/SmallButton');const ContentContainer_1=require('../../components/ContentContainer');const InfoIcon_1=require('../../components/styled/InfoIcon');const CopyAddress_1=require('../../../common/CopyAddress');const HeroTitle_1=require('../../components/HeroTitle');const ConfigProposalFormLambda_1=require('../../components/ConfigProposalFormLambda');const ConfigProposalForm_1=require('../../components/ConfigProposalForm');const GuardianChangeProposalForm_1=require('../../components/GuardianChangeProposalForm');const lambdas_1=require('../../../../services/bakingBad/lambdas');const DelegationChangeProposalForm_1=require('../../components/DelegationChangeProposalForm');const DAOInfoTable_1=require('./components/DAOInfoTable');const types_1=require('../../../../services/services/dao/mappers/proposal/types');const ProposalCreatorModal_1=require('../../../lite/explorer/pages/CreateProposal/ProposalCreatorModal');const getActions=()=>[{name:'Off Chain Poll',description:'Create an inconsequential poll for your community',id:'off-chain',isLambda:true},{name:'Add Lambda',description:'Write Michelson code to add Lambda',id:ConfigProposalFormLambda_1.ProposalAction.new,isLambda:true},{name:'Remove Lambda',description:'Choose which Lambda to remove',id:ConfigProposalFormLambda_1.ProposalAction.remove,isLambda:true},{name:'Execute Lambda',description:'Execute a Lambda already installed on DAO',id:ConfigProposalFormLambda_1.ProposalAction.execute,isLambda:true},{name:'DAO Configuration',description:'Change proposal fee and returned token amount',id:lambdas_1.SupportedLambdaProposalKey.ConfigurationProposal,isLambda:false},{name:'Change Guardian',description:'Change the DAO Guardian Address',id:lambdas_1.SupportedLambdaProposalKey.UpdateGuardianProposal,isLambda:false},{name:'Change Delegate',description:'Change the DAO Delegate Address',id:lambdas_1.SupportedLambdaProposalKey.UpdateContractDelegateProposal,isLambda:false}];const HeroContainer=(0,core_1.styled)(ContentContainer_1.ContentContainer)(({theme})=>({padding:'38px',display:'inline-flex',alignItems:'center',maxHeight:132,[theme.breakpoints.down('sm')]:{maxHeight:'fit-content'}}));exports.DropButton=(0,core_1.styled)(core_1.Button)({verticalAlign:'text-bottom',fontSize:'16px'});const OptionContainer=(0,core_1.styled)(core_1.Grid)(({theme})=>({'minHeight':80,'background':theme.palette.primary.main,'borderRadius':8,'padding':'35px 42px','marginBottom':16,'cursor':'pointer','&:hover':{background:theme.palette.secondary.dark,scale:1.01,transition:'0.15s ease-in'}}));const ActionText=(0,core_1.styled)(core_1.Typography)(({theme})=>({fontWeight:400,fontSize:20,marginBottom:8}));const ActionDescriptionText=(0,core_1.styled)(core_1.Typography)(({theme})=>({fontWeight:300,fontSize:16}));const defaultOpenSupportedExecuteProposalModal='none';const Config=()=>{var _a;const theme=(0,core_1.useTheme)();const isMobileSmall=(0,core_1.useMediaQuery)(theme.breakpoints.down('sm'));const [openModal,setOpenModal]=(0,react_1.useState)(false);const [openModalLambda,setOpenModalLambda]=(0,react_1.useState)(false);const daoId=(0,router_1.useDAOID)();const {data}=(0,useDAO_1.useDAO)(daoId);const {mutate}=(0,useFlush_1.useFlush)();const {mutate:dropAllExpired}=(0,useDropAllExpired_1.useDropAllExpired)();const {data:executableProposals}=(0,useProposals_1.useProposals)(daoId,types_1.ProposalStatus.EXECUTABLE);const {data:expiredProposals}=(0,useProposals_1.useProposals)(daoId,types_1.ProposalStatus.EXPIRED);const name=data&&data.data.name;const [proposalAction,setProposalAction]=(0,react_1.useState)(ConfigProposalFormLambda_1.ProposalAction.none);const [openProposalFormLambda,setOpenProposalFormLambda]=(0,react_1.useState)(false);const [openLiteProposal,setOpenLiteProposal]=(0,react_1.useState)(false);const liteDAOId=(_a=data===null||data===void 0?void 0:data.liteDAOData)===null||_a===void 0?void 0:_a._id;const handleOpenCustomProposalModal=key=>{setProposalAction(key);setOpenProposalFormLambda(true);};const handleCloseCustomProposalModal=()=>{setProposalAction(ConfigProposalFormLambda_1.ProposalAction.none);setOpenProposalFormLambda(false);};const handleOpenSupportedExecuteProposalModal=lambdaKey=>{setOpenSupportedExecuteProposalModal(lambdaKey);};const handleCloseSupportedExecuteProposalModal=()=>{setOpenLiteProposal(false);setOpenSupportedExecuteProposalModal(defaultOpenSupportedExecuteProposalModal);};const handleLiteProposal=()=>{setOpenLiteProposal(true);};const [openSupportedExecuteProposalModalKey,setOpenSupportedExecuteProposalModal]=(0,react_1.useState)(defaultOpenSupportedExecuteProposalModal);const onFlush=(0,react_1.useCallback)(()=>__awaiter(void 0,void 0,void 0,function*(){if(executableProposals&&expiredProposals&&executableProposals.length&&data){mutate({dao:data,numOfProposalsToFlush:executableProposals.length,expiredProposalIds:expiredProposals.map(p=>p.id)});return;}}),[data,mutate,executableProposals,expiredProposals]);const onDropAllExpired=(0,react_1.useCallback)(()=>__awaiter(void 0,void 0,void 0,function*(){if(expiredProposals&&expiredProposals.length&&data){dropAllExpired({dao:data,expiredProposalIds:expiredProposals.map(p=>p.id)});return;}}),[data,dropAllExpired,expiredProposals]);return(0,jsx_runtime_1.jsxs)(jsx_runtime_1.Fragment,{children:[(0,jsx_runtime_1.jsx)(core_1.Grid,{container:true,direction:'column',style:{gap:42},children:(0,jsx_runtime_1.jsx)(HeroContainer,{item:true,children:(0,jsx_runtime_1.jsx)(core_1.Grid,{container:true,justifyContent:'space-between',alignItems:isMobileSmall?'baseline':'center',children:(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,xs:12,children:(0,jsx_runtime_1.jsxs)(core_1.Grid,{container:true,style:{gap:20},alignItems:'center',justifyContent:'space-between',direction:isMobileSmall?'column':'row',children:[(0,jsx_runtime_1.jsxs)(core_1.Grid,{item:true,xs:isMobileSmall?undefined:5,children:[(0,jsx_runtime_1.jsx)(HeroTitle_1.HeroTitle,{children:name}),data&&(0,jsx_runtime_1.jsx)(CopyAddress_1.CopyAddress,{address:data.data.address,justifyContent:isMobileSmall?'center':'flex-start',typographyProps:{variant:'subtitle2'}})]}),(0,jsx_runtime_1.jsxs)(core_1.Grid,{item:true,xs:isMobileSmall?undefined:6,container:true,justifyContent:isMobileSmall?'center':'flex-end',alignItems:'center',style:{gap:20},children:[(0,jsx_runtime_1.jsxs)(core_1.Grid,{item:true,children:[(0,jsx_runtime_1.jsx)(SmallButton_1.SmallButton,{variant:'contained',color:'secondary',onClick:onFlush,disabled:!executableProposals||!executableProposals.length,children:'Execute'}),(0,jsx_runtime_1.jsx)(core_1.Tooltip,{placement:'bottom',title:'Execute all passed proposals and drop all expired or rejected',children:(0,jsx_runtime_1.jsx)(InfoIcon_1.InfoIcon,{color:'secondary'})})]}),(0,jsx_runtime_1.jsxs)(core_1.Grid,{item:true,children:[(0,jsx_runtime_1.jsx)(exports.DropButton,{variant:'contained',color:'secondary',onClick:onDropAllExpired,disabled:!expiredProposals||!expiredProposals.length,children:'Drop All Expired'}),(0,jsx_runtime_1.jsx)(core_1.Tooltip,{placement:'bottom',title:'Drop all expired proposals',children:(0,jsx_runtime_1.jsx)(InfoIcon_1.InfoIcon,{color:'secondary'})})]})]})]})})})})}),(0,jsx_runtime_1.jsx)(core_1.Grid,{container:true,style:{marginTop:32},spacing:2,children:getActions().map((elem,index)=>!liteDAOId&&elem.id==='off-chain'?null:(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,xs:isMobileSmall?12:4,children:(0,jsx_runtime_1.jsxs)(OptionContainer,{onClick:()=>elem.id==='off-chain'?handleLiteProposal():elem.isLambda?handleOpenCustomProposalModal(elem.id):handleOpenSupportedExecuteProposalModal(elem.id),children:[(0,jsx_runtime_1.jsx)(ActionText,{color:'textPrimary',children:elem.name}),(0,jsx_runtime_1.jsxs)(ActionDescriptionText,{color:'textPrimary',children:[' ',elem.description,' ']})]})},index))}),(0,jsx_runtime_1.jsx)(DAOInfoTable_1.DaoInfoTables,{}),openProposalFormLambda?(0,jsx_runtime_1.jsx)(ConfigProposalFormLambda_1.ProposalFormLambda,{action:proposalAction,open:openProposalFormLambda,handleClose:handleCloseCustomProposalModal}):null,openSupportedExecuteProposalModalKey===lambdas_1.SupportedLambdaProposalKey.ConfigurationProposal?(0,jsx_runtime_1.jsx)(ConfigProposalForm_1.ConfigProposalForm,{open:openSupportedExecuteProposalModalKey===lambdas_1.SupportedLambdaProposalKey.ConfigurationProposal,handleClose:handleCloseSupportedExecuteProposalModal}):null,openSupportedExecuteProposalModalKey===lambdas_1.SupportedLambdaProposalKey.UpdateGuardianProposal?(0,jsx_runtime_1.jsx)(GuardianChangeProposalForm_1.GuardianChangeProposalForm,{open:openSupportedExecuteProposalModalKey===lambdas_1.SupportedLambdaProposalKey.UpdateGuardianProposal,handleClose:handleCloseSupportedExecuteProposalModal}):null,openSupportedExecuteProposalModalKey===lambdas_1.SupportedLambdaProposalKey.UpdateContractDelegateProposal?(0,jsx_runtime_1.jsx)(DelegationChangeProposalForm_1.DelegationChangeProposalForm,{open:openSupportedExecuteProposalModalKey===lambdas_1.SupportedLambdaProposalKey.UpdateContractDelegateProposal,handleClose:handleCloseSupportedExecuteProposalModal}):null,openLiteProposal?(0,jsx_runtime_1.jsx)(ProposalCreatorModal_1.ProposalCreatorModal,{open:openLiteProposal,handleClose:handleCloseSupportedExecuteProposalModal}):null]});};exports.Config=Config;