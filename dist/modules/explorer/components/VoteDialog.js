'use strict';var __createBinding=this&&this.__createBinding||(Object.create?function(o,m,k,k2){if(k2===undefined)k2=k;var desc=Object.getOwnPropertyDescriptor(m,k);if(!desc||('get'in desc?!m.__esModule:desc.writable||desc.configurable)){desc={enumerable:true,get:function(){return m[k];}};}Object.defineProperty(o,k2,desc);}:function(o,m,k,k2){if(k2===undefined)k2=k;o[k2]=m[k];});var __setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(o,v){Object.defineProperty(o,'default',{enumerable:true,value:v});}:function(o,v){o['default']=v;});var __importStar=this&&this.__importStar||function(mod){if(mod&&mod.__esModule)return mod;var result={};if(mod!=null)for(var k in mod)if(k!=='default'&&Object.prototype.hasOwnProperty.call(mod,k))__createBinding(result,mod,k);__setModuleDefault(result,mod);return result;};var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){function adopt(value){return value instanceof P?value:new P(function(resolve){resolve(value);});}return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value));}catch(e){reject(e);}}function rejected(value){try{step(generator['throw'](value));}catch(e){reject(e);}}function step(result){result.done?resolve(result.value):adopt(result.value).then(fulfilled,rejected);}step((generator=generator.apply(thisArg,_arguments||[])).next());});};var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{'default':mod};};Object.defineProperty(exports,'__esModule',{value:true});exports.VoteDialog=void 0;const jsx_runtime_1=require('react/jsx-runtime');const react_1=__importStar(require('react'));const core_1=require('@material-ui/core');const react_router_dom_1=require('react-router-dom');const useVote_1=require('../../../services/contracts/baseDAO/hooks/useVote');const bignumber_js_1=__importDefault(require('bignumber.js'));const useDAO_1=require('../../../services/services/dao/hooks/useDAO');const router_1=require('../pages/DAO/router');const ResponsiveDialog_1=require('./ResponsiveDialog');const useTopic_1=require('../../../services/agora/hooks/useTopic');const useProposal_1=require('../../../services/services/dao/hooks/useProposal');const utils_1=require('../../../services/contracts/utils');const ProposalFormInput_1=require('./ProposalFormInput');const useTezos_1=require('../../../services/beacon/hooks/useTezos');const useTezosBalance_1=require('../../../services/contracts/baseDAO/hooks/useTezosBalance');const CustomLabelsContainer=(0,core_1.styled)(core_1.Grid)({marginBottom:12});const CustomAmountLabel=(0,core_1.styled)(core_1.Typography)({fontWeight:500});const CustomMaxLabel=(0,core_1.styled)(core_1.Typography)({fontSize:16,paddingBottom:5,textDecoration:'underline',textUnderlineOffset:6,cursor:'pointer',marginLeft:12});const ErrorText=(0,core_1.styled)(core_1.Typography)({fontSize:13,marginTop:8,color:'red'});const VoteDialog=({support,onClose,open})=>{const [amount,setAmount]=react_1.default.useState('0');const {proposalId}=(0,react_router_dom_1.useParams)();const daoId=(0,router_1.useDAOID)();const {data:dao,ledger}=(0,useDAO_1.useDAO)(daoId);const {data:proposal}=(0,useProposal_1.useProposal)(daoId,proposalId);const {data:agoraPost}=(0,useTopic_1.useAgoraTopic)(Number(proposal===null||proposal===void 0?void 0:proposal.metadata.agoraPostId));const {mutate}=(0,useVote_1.useVote)();const theme=(0,core_1.useTheme)();const {data:tezosBalance}=(0,useTezosBalance_1.useTezosBalance)(daoId);const [max,setMax]=react_1.default.useState(0);const [error,setError]=react_1.default.useState(false);const validate=(0,react_1.useCallback)(()=>{if(Number(amount)>max){setError(true);return true;}setError(false);return false;},[amount,max,setError]);const onSubmit=(0,react_1.useCallback)(()=>__awaiter(void 0,void 0,void 0,function*(){if(!validate()){if(dao){mutate({proposalKey:proposalId,dao,amount:new bignumber_js_1.default(amount),support});onClose();}}}),[amount,dao,mutate,onClose,proposalId,support,validate]);const {account}=(0,useTezos_1.useTezos)();(0,react_1.useMemo)(()=>{const found=ledger===null||ledger===void 0?void 0:ledger.find(l=>l.holder.address.toLowerCase()===account.toLowerCase());const value=found||{available_balance:new bignumber_js_1.default(0)};setMax(value.available_balance.toNumber());return value;},[account,ledger]);(0,react_1.useEffect)(()=>{if(!open){setAmount('0');setError(false);}},[open]);return(0,jsx_runtime_1.jsx)(jsx_runtime_1.Fragment,{children:(0,jsx_runtime_1.jsx)(ResponsiveDialog_1.ResponsiveDialog,{open:open,onClose:onClose,title:support?'Support':'Oppose',customTitleColor:support?theme.palette.secondary.main:'#FF5555',children:(0,jsx_runtime_1.jsxs)(core_1.Grid,{container:true,direction:'column',style:{gap:36},children:[(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,children:(0,jsx_runtime_1.jsxs)(core_1.Typography,{variant:'body2',color:'textPrimary',children:['Confirm your vote to ',support?'support':'oppose',' Proposal #',(0,utils_1.toShortAddress)(proposalId)]})}),agoraPost&&(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,children:(0,jsx_runtime_1.jsx)(core_1.Typography,{color:'textPrimary',variant:'body2',children:agoraPost.title})}),(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,container:true,direction:'row',children:(0,jsx_runtime_1.jsxs)(core_1.Grid,{item:true,xs:true,children:[(0,jsx_runtime_1.jsxs)(CustomLabelsContainer,{item:true,container:true,direction:'row',justifyContent:'space-between',alignItems:'center',children:[(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,xs:3,children:(0,jsx_runtime_1.jsx)(CustomAmountLabel,{children:'Amount'})}),(0,jsx_runtime_1.jsxs)(core_1.Grid,{item:true,container:true,direction:'row',xs:9,justifyContent:'flex-end',children:[(0,jsx_runtime_1.jsxs)(core_1.Typography,{children:[max,' ',dao===null||dao===void 0?void 0:dao.data.token.symbol]}),(0,jsx_runtime_1.jsx)(CustomMaxLabel,{color:'secondary',onClick:()=>setAmount(String(max)),children:'Use Max'})]})]}),(0,jsx_runtime_1.jsx)(ProposalFormInput_1.ProposalFormInput,{children:(0,jsx_runtime_1.jsx)(core_1.TextField,{type:'number',value:amount,placeholder:'Type an Amount',inputProps:{min:0,max:max},InputProps:{disableUnderline:true},onChange:newValue=>{setError(false);setAmount(newValue.target.value);},onKeyPress:e=>{e.key==='-'?e.preventDefault():null;}})}),error?(0,jsx_runtime_1.jsx)(ErrorText,{children:'Amount cannot be greater than max available'}):null]})}),(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,container:true,direction:'row',alignItems:'center',justifyContent:'center',children:(0,jsx_runtime_1.jsx)(core_1.Button,{variant:'contained',color:'secondary',disabled:!amount||error,onClick:onSubmit,children:'Submit'})})]})})});};exports.VoteDialog=VoteDialog;