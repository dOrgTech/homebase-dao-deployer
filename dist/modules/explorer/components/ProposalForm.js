'use strict';var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{'default':mod};};Object.defineProperty(exports,'__esModule',{value:true});exports.ProposalFormContainer=void 0;const jsx_runtime_1=require('react/jsx-runtime');const core_1=require('@material-ui/core');const UpdateRegistryDialog_1=require('./UpdateRegistryDialog');const NewTreasuryProposalDialog_1=require('./NewTreasuryProposalDialog');const react_1=require('react');const useDAO_1=require('../../../services/services/dao/hooks/useDAO');const ProposalFormSendButton_1=require('./ProposalFormSendButton');const TabPanel_1=require('./TabPanel');const useDAOHoldings_1=require('../../../services/contracts/baseDAO/hooks/useDAOHoldings');const react_hook_form_1=require('react-hook-form');const useRegistryPropose_1=require('../../../services/contracts/baseDAO/hooks/useRegistryPropose');const NFTTransfer_1=require('./NFTTransfer');const router_1=require('../pages/DAO/router');const ProposalFormInput_1=require('./ProposalFormInput');const ResponsiveDialog_1=require('./ResponsiveDialog');const CloseButton_1=__importDefault(require('../../common/CloseButton'));const swap_svg_1=require('../../../assets/img/swap.svg');const CustomContainer=(0,core_1.styled)(core_1.Grid)({padding:'42px 54px 0px 54px'});const IconSwap=(0,core_1.styled)(swap_svg_1.ReactComponent)({marginLeft:16,marginRight:16,cursor:'pointer'});const DialogTitle=(0,core_1.styled)(core_1.Typography)({fontSize:20,fontWeight:500,textTransform:'capitalize'});const enabledForms={'lambda':[{label:'TRANSFER FUNDS',component:({open})=>(0,jsx_runtime_1.jsx)(NewTreasuryProposalDialog_1.NewTreasuryProposalDialog,{open:open})},{label:'TRANSFER NFTs',component:({open})=>(0,jsx_runtime_1.jsx)(NFTTransfer_1.NFTTransferForm,{open:open})},{label:'UPDATE REGISTRY',component:({open})=>(0,jsx_runtime_1.jsx)(UpdateRegistryDialog_1.UpdateRegistryDialog,{open:open})}],'':[],'lite':[]};const Content=(0,core_1.styled)(core_1.Grid)({padding:'0 54px'});const SwapText=(0,core_1.styled)(core_1.Typography)({opacity:0.65});const ProposalFormContainer=({open,handleClose,defaultValues,defaultTab,handleChangeTab})=>{const daoId=(0,router_1.useDAOID)();const {data:dao}=(0,useDAO_1.useDAO)(daoId);const {data:daoHoldings}=(0,useDAOHoldings_1.useDAOHoldings)(daoId);const [state,setState]=(0,react_1.useState)(defaultTab);const methods=(0,react_hook_form_1.useForm)({defaultValues:(0,react_1.useMemo)(()=>Object.assign(Object.assign(Object.assign(Object.assign({agoraPostId:'0'},NewTreasuryProposalDialog_1.treasuryProposalFormInitialState),NFTTransfer_1.nftTransferFormInitialState),UpdateRegistryDialog_1.registryProposalFormInitialState),defaultValues),[defaultValues])});(0,react_1.useEffect)(()=>{methods.reset(Object.assign(Object.assign(Object.assign(Object.assign({agoraPostId:'0'},NewTreasuryProposalDialog_1.treasuryProposalFormInitialState),NFTTransfer_1.nftTransferFormInitialState),UpdateRegistryDialog_1.registryProposalFormInitialState),defaultValues));},[defaultValues,methods]);const forms=enabledForms[(dao===null||dao===void 0?void 0:dao.data.type)||'lambda'];const {mutate:registryMutate}=(0,useRegistryPropose_1.useRegistryPropose)();const onSubmit=(0,react_1.useCallback)(values=>{const agoraPostId=Number(values.agoraPostId);const mappedTransfers=[...values.transferForm.transfers,...values.nftTransferForm.transfers].filter(transfer=>!!transfer.amount&&!!transfer.asset&&!!transfer.recipient).map(transfer=>{const type=transfer.asset.standard==='fa2'?'FA2':'FA1.2';return transfer.asset.symbol==='XTZ'?Object.assign(Object.assign({},transfer),{amount:transfer.amount,type:'XTZ'}):Object.assign(Object.assign({},transfer),{amount:transfer.amount,asset:transfer.asset,type:type});});const mappedList=values.registryUpdateForm.list.filter(item=>!!item.key&&!!item.value);if(dao.data.type==='lambda'){registryMutate({dao:dao,args:{agoraPostId,transfer_proposal:{transfers:mappedTransfers,registry_diff:mappedList}}});}methods.reset();handleClose();},[dao,handleClose,methods,registryMutate]);const getLabel=selectedTab=>{switch(selectedTab){case 0:return'NFT';case 1:return'Funds';case 2:return'';}};const changeTab=state=>{setState(state);if(state===0){handleChangeTab===null||handleChangeTab===void 0?void 0:handleChangeTab(1);}else if(state===1){handleChangeTab===null||handleChangeTab===void 0?void 0:handleChangeTab(0);}else{return;}};return(0,jsx_runtime_1.jsx)(react_hook_form_1.FormProvider,Object.assign({},methods,{children:(0,jsx_runtime_1.jsx)(ResponsiveDialog_1.ProposalFormResponsiveDialog,{open:open,onClose:handleClose,children:dao&&daoHoldings&&(0,jsx_runtime_1.jsxs)(jsx_runtime_1.Fragment,{children:[(0,jsx_runtime_1.jsxs)(CustomContainer,{container:true,direction:'row',justifyContent:'space-between',alignItems:'center',children:[(0,jsx_runtime_1.jsxs)(core_1.Grid,{item:true,container:true,direction:'row',alignItems:'center',style:{width:'80%'},children:[(0,jsx_runtime_1.jsx)(DialogTitle,{children:forms[defaultTab].label.toLowerCase()}),defaultTab===0||defaultTab===1?(0,jsx_runtime_1.jsx)(IconSwap,{onClick:()=>changeTab(defaultTab)}):null,(0,jsx_runtime_1.jsx)(SwapText,{children:getLabel(defaultTab)})]}),(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,children:(0,jsx_runtime_1.jsx)(CloseButton_1.default,{onClose:handleClose})})]}),forms.map((form,i)=>(0,jsx_runtime_1.jsx)(TabPanel_1.TabPanel,{value:defaultTab,index:i,children:(0,jsx_runtime_1.jsx)(form.component,{open:open})},`tab-${i}`)),(0,jsx_runtime_1.jsxs)(Content,{container:true,direction:'column',style:{gap:10},children:[(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,children:(0,jsx_runtime_1.jsx)(ProposalFormInput_1.ProposalFormInput,{label:'Agora Post ID',children:(0,jsx_runtime_1.jsx)(react_hook_form_1.Controller,{control:methods.control,name:`agoraPostId`,render:({field})=>(0,jsx_runtime_1.jsx)(core_1.TextField,Object.assign({},field,{type:'number',placeholder:'Type an Agora Post ID',InputProps:{disableUnderline:true}}))})})}),(0,jsx_runtime_1.jsxs)(core_1.Grid,{item:true,children:[(0,jsx_runtime_1.jsxs)(core_1.Typography,{align:'left',variant:'subtitle2',color:'textPrimary',display:'inline',children:['Proposal Fee:',' ']}),(0,jsx_runtime_1.jsxs)(core_1.Typography,{align:'left',variant:'subtitle2',color:'secondary',display:'inline',style:{fontWeight:300},children:[dao&&dao.data.extra.frozen_extra_value.toString(),' ',dao?dao.data.token.symbol:'']})]}),(0,jsx_runtime_1.jsx)(ProposalFormSendButton_1.SendButton,{style:{margin:'10px 0 35px 0'},onClick:methods.handleSubmit(onSubmit),disabled:!dao||!daoHoldings,children:'Submit'})]})]})})}));};exports.ProposalFormContainer=ProposalFormContainer;