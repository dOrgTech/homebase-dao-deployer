'use strict';var __createBinding=this&&this.__createBinding||(Object.create?function(o,m,k,k2){if(k2===undefined)k2=k;var desc=Object.getOwnPropertyDescriptor(m,k);if(!desc||('get'in desc?!m.__esModule:desc.writable||desc.configurable)){desc={enumerable:true,get:function(){return m[k];}};}Object.defineProperty(o,k2,desc);}:function(o,m,k,k2){if(k2===undefined)k2=k;o[k2]=m[k];});var __setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(o,v){Object.defineProperty(o,'default',{enumerable:true,value:v});}:function(o,v){o['default']=v;});var __importStar=this&&this.__importStar||function(mod){if(mod&&mod.__esModule)return mod;var result={};if(mod!=null)for(var k in mod)if(k!=='default'&&Object.prototype.hasOwnProperty.call(mod,k))__createBinding(result,mod,k);__setModuleDefault(result,mod);return result;};Object.defineProperty(exports,'__esModule',{value:true});exports.ProposalFormLambda=exports.ProposalAction=void 0;const jsx_runtime_1=require('react/jsx-runtime');const core_1=require('@material-ui/core');const react_1=__importStar(require('react'));const useDAO_1=require('../../../services/services/dao/hooks/useDAO');const react_hook_form_1=require('react-hook-form');const router_1=require('../pages/DAO/router');const ProposalFormInput_1=require('./ProposalFormInput');const ResponsiveDialog_1=require('./ResponsiveDialog');const prismjs_1=__importStar(require('prismjs'));require('prism-themes/themes/prism-night-owl.css');const MainButton_1=require('../../common/MainButton');const SearchLambda_1=require('./styled/SearchLambda');const icons_1=require('@material-ui/icons');const useLambdaAddPropose_1=require('../../../services/contracts/baseDAO/hooks/useLambdaAddPropose');const useLambdaRemovePropose_1=require('../../../services/contracts/baseDAO/hooks/useLambdaRemovePropose');const useDAOLambdas_1=require('../../../services/contracts/baseDAO/hooks/useDAOLambdas');const useLambdaExecutePropose_1=require('../../../services/contracts/baseDAO/hooks/useLambdaExecutePropose');const utils_1=require('utils');const StyledSendButton=(0,core_1.styled)(MainButton_1.MainButton)(({theme})=>({width:101,color:'#1C1F23'}));const StyledRow=(0,core_1.styled)(core_1.Grid)({marginTop:30});const LoadingContainer=(0,core_1.styled)(core_1.Grid)({minHeight:651});const LoadingStateLabel=(0,core_1.styled)(core_1.Typography)({marginTop:40});const CheckIcon=(0,core_1.styled)(icons_1.CheckOutlined)({fontSize:169});const codeEditorcontainerstyles={marginTop:'8px'};const codeEditorStyles={minHeight:500,fontFamily:'Roboto Mono',fontSize:14,fontWeight:400,outlineWidth:0};var ProposalAction;(function(ProposalAction){ProposalAction[ProposalAction['new']=0]='new';ProposalAction[ProposalAction['remove']=1]='remove';ProposalAction[ProposalAction['execute']=2]='execute';ProposalAction[ProposalAction['none']=3]='none';}(ProposalAction||(exports.ProposalAction=ProposalAction={})));var LambdaProposalState;(function(LambdaProposalState){LambdaProposalState[LambdaProposalState['write_action']=0]='write_action';LambdaProposalState[LambdaProposalState['wallet_action']=1]='wallet_action';LambdaProposalState[LambdaProposalState['action_finished']=2]='action_finished';}(LambdaProposalState||(LambdaProposalState={})));const codeEditorPlaceholder={addLambda:`Write Michelson Code for Lambda's Implementation

Eg:-

(Left (Left (Pair (Pair { DROP ;
    NIL operation ;
    EMPTY_MAP string bytes ;
    NONE address ;
    PAIR ;
    PAIR }
  { DROP ; UNIT })
"sample")))
  `,existingLambda:`Choose a Lambda from the Dropdown, the implementation will appear here
  `,lambdaExecuteArgumentsCode:`Write Michelson Code for the input Paramerers of your Lambda

Eg:-

{
  "prim": "pair",
  "annots": [
    "%xtz_transfer_type"
  ],
  "args": [
    {
      "prim": "mutez",
      "annots": [
        "%amount"
      ]
    },
    {
      "prim": "address",
      "annots": [
        "%recipient"
      ]
    }
  ]
},
`,lambdaExecuteParams:`Enter the values for the given params in a JSON/JavaScript Object format.

Eg:-

{
  xtz_transfer_type: {
    amount: 10000000000000000000,
    recipient: "tz1VSUr8wwNhLAzempoch5d6hLRiTh8Cjcjb"
  }
}
  `};const ProposalFormLambda=({open,handleClose,action})=>{const grammar=prismjs_1.default.languages.javascript;const daoId=(0,router_1.useDAOID)();const {data:dao}=(0,useDAO_1.useDAO)(daoId);const daoLambdas=(0,useDAOLambdas_1.useDAOLambdas)(daoId);const {mutate:lambdaAdd}=(0,useLambdaAddPropose_1.useLambdaAddPropose)();const {mutate:lambdaRemove}=(0,useLambdaRemovePropose_1.useLambdaRemovePropose)();const {mutate:lambdaExecute}=(0,useLambdaExecutePropose_1.useLambdaExecutePropose)();const lambdaForm=(0,react_hook_form_1.useForm)();const [lambda,setLambda]=react_1.default.useState(null);const [state,setState]=react_1.default.useState(LambdaProposalState.write_action);const [lambdaParams,setLambdaParams]=react_1.default.useState('');const [lambdaArguments,setLambdaArguments]=react_1.default.useState('');const [code,setCode]=react_1.default.useState('');(0,react_1.useEffect)(()=>{if(open){setCode('');setState(LambdaProposalState.write_action);setLambda(null);lambdaForm.reset();}},[open,lambdaForm]);const onSubmit=(0,react_1.useCallback)(_=>{const agoraPostId=Number(0);switch(action){case ProposalAction.new:{lambdaAdd({dao:dao,args:{agoraPostId,data:code},handleClose});break;}case ProposalAction.remove:{if(!lambda){return;}setCode('');lambdaRemove({dao:dao,args:{agoraPostId,handler_name:lambda.key},handleClose});break;}case ProposalAction.execute:{if(!lambda||lambdaArguments===''||lambdaParams===''){return;}setCode('');const lambdaCode=JSON.parse(code);const handler_code={code:JSON.stringify(lambdaCode.code),handler_check:JSON.stringify(lambdaCode.handler_check),is_active:lambdaCode.is_active};lambdaExecute({dao:dao,args:{agoraPostId,handler_name:lambda.key,handler_code,handler_params:lambdaParams,lambda_arguments:lambdaArguments},handleClose});break;}default:}},[dao,lambdaAdd,code,action,lambda,lambdaRemove,lambdaArguments,lambdaExecute,lambdaParams,handleClose]);const handleSearchChange=data=>{if(!(data===null||data===void 0?void 0:data.value)){lambdaForm.reset();setCode('');return;}lambdaForm.setValue('lambda_name',data.key);setLambda(data);setCode((0,utils_1.parseLambdaCode)(data.value));return;};const renderNewProposal=()=>{return(0,jsx_runtime_1.jsx)(jsx_runtime_1.Fragment,{children:(0,jsx_runtime_1.jsx)(ProposalFormInput_1.ProposalCodeEditorInput,{label:'Implementation',containerstyle:codeEditorcontainerstyles,insertSpaces:true,ignoreTabKey:false,tabSize:4,padding:10,style:codeEditorStyles,value:code,onValueChange:code=>setCode(code),highlight:code=>(0,prismjs_1.highlight)(code,grammar,'javascript'),placeholder:codeEditorPlaceholder.addLambda})});};const renderRemoveProposal=()=>{return(0,jsx_runtime_1.jsxs)(jsx_runtime_1.Fragment,{children:[(0,jsx_runtime_1.jsx)(ProposalFormInput_1.ProposalFormInput,{label:'Lambda Name',children:(0,jsx_runtime_1.jsx)(SearchLambda_1.SearchLambda,{lambdas:daoLambdas,handleChange:handleSearchChange})}),(0,jsx_runtime_1.jsx)(ProposalFormInput_1.ProposalCodeEditorInput,{label:'Implementation',containerstyle:codeEditorcontainerstyles,insertSpaces:true,ignoreTabKey:false,tabSize:4,padding:10,style:codeEditorStyles,value:code,onValueChange:code=>setCode(code),highlight:code=>(0,prismjs_1.highlight)(code,grammar,'javascript'),placeholder:codeEditorPlaceholder.lambdaExecuteArgumentsCode})]});};const renderExecuteProposal=()=>{return(0,jsx_runtime_1.jsxs)(jsx_runtime_1.Fragment,{children:[(0,jsx_runtime_1.jsx)(ProposalFormInput_1.ProposalFormInput,{label:'Lambda Name',children:(0,jsx_runtime_1.jsx)(SearchLambda_1.SearchLambda,{lambdas:daoLambdas,handleChange:handleSearchChange})}),(0,jsx_runtime_1.jsx)(ProposalFormInput_1.ProposalCodeEditorInput,{label:'Implementation',containerstyle:codeEditorcontainerstyles,insertSpaces:true,ignoreTabKey:false,tabSize:4,padding:10,style:codeEditorStyles,value:code,onValueChange:code=>setCode(code),highlight:code=>(0,prismjs_1.highlight)(code,grammar,'javascript'),placeholder:codeEditorPlaceholder.existingLambda}),(0,jsx_runtime_1.jsx)(ProposalFormInput_1.ProposalCodeEditorInput,{label:'Lambda Arguments Code',containerstyle:codeEditorcontainerstyles,insertSpaces:true,ignoreTabKey:false,tabSize:4,padding:10,value:lambdaArguments,onValueChange:lambdaArguments=>setLambdaArguments(lambdaArguments),highlight:lambdaArguments=>(0,prismjs_1.highlight)(lambdaArguments,grammar,'javascript'),style:codeEditorStyles,placeholder:codeEditorPlaceholder.lambdaExecuteArgumentsCode}),(0,jsx_runtime_1.jsx)(ProposalFormInput_1.ProposalCodeEditorInput,{label:'Lambda Params',containerstyle:codeEditorcontainerstyles,insertSpaces:true,ignoreTabKey:false,tabSize:4,padding:10,style:codeEditorStyles,value:lambdaParams,onValueChange:lambdaParams=>setLambdaParams(lambdaParams),highlight:lambdaParams=>(0,prismjs_1.highlight)(lambdaParams,grammar,'javascript'),placeholder:codeEditorPlaceholder.lambdaExecuteParams})]});};return(0,jsx_runtime_1.jsx)(react_hook_form_1.FormProvider,Object.assign({},lambdaForm,{children:(0,jsx_runtime_1.jsxs)(ResponsiveDialog_1.ResponsiveDialog,{open:open,onClose:handleClose,title:ProposalAction[action]+' Lambda Proposal',template:'md',children:[state===LambdaProposalState.write_action?(0,jsx_runtime_1.jsxs)(jsx_runtime_1.Fragment,{children:[(0,jsx_runtime_1.jsxs)(core_1.Grid,{container:true,direction:'row',spacing:4,children:[action===ProposalAction.new?renderNewProposal():null,action===ProposalAction.remove?renderRemoveProposal():null,action===ProposalAction.execute?renderExecuteProposal():null]}),(0,jsx_runtime_1.jsx)(StyledRow,{container:true,direction:'row',spacing:4,justifyContent:'flex-end',children:(0,jsx_runtime_1.jsx)(StyledSendButton,{onClick:lambdaForm.handleSubmit(onSubmit),disabled:!code,children:'Submit'})})]}):null,state===LambdaProposalState.wallet_action?(0,jsx_runtime_1.jsx)(jsx_runtime_1.Fragment,{children:(0,jsx_runtime_1.jsxs)(LoadingContainer,{container:true,direction:'column',alignItems:'center',justifyContent:'center',children:[(0,jsx_runtime_1.jsx)(core_1.CircularProgress,{color:'secondary',size:169}),(0,jsx_runtime_1.jsx)(LoadingStateLabel,{children:'Confirm action in wallet'})]})}):null,state===LambdaProposalState.action_finished?(0,jsx_runtime_1.jsx)(jsx_runtime_1.Fragment,{children:(0,jsx_runtime_1.jsxs)(LoadingContainer,{container:true,direction:'column',alignItems:'center',justifyContent:'center',children:[(0,jsx_runtime_1.jsx)(CheckIcon,{color:'secondary'}),(0,jsx_runtime_1.jsx)(LoadingStateLabel,{children:'Proposal created'})]})}):null]})}));};exports.ProposalFormLambda=ProposalFormLambda;