'use strict';var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){function adopt(value){return value instanceof P?value:new P(function(resolve){resolve(value);});}return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value));}catch(e){reject(e);}}function rejected(value){try{step(generator['throw'](value));}catch(e){reject(e);}}function step(result){result.done?resolve(result.value):adopt(result.value).then(fulfilled,rejected);}step((generator=generator.apply(thisArg,_arguments||[])).next());});};Object.defineProperty(exports,'__esModule',{value:true});exports.ProposalDetails=void 0;const jsx_runtime_1=require('react/jsx-runtime');const react_1=require('react');const core_1=require('@material-ui/core');const ProposalDetailCard_1=require('../../components/ProposalDetailCard');const GridContainer_1=require('../../../../common/GridContainer');const ChoiceItemSelected_1=require('../../components/ChoiceItemSelected');const VoteDetails_1=require('../../components/VoteDetails');const react_router_dom_1=require('react-router-dom');const useTezos_1=require('../../../../../services/beacon/hooks/useTezos');const utils_1=require('../../../../../services/lite/utils');const useNotification_1=require('../../../../common/hooks/useNotification');const usePollChoices_1=require('../../hooks/usePollChoices');const useCommunity_1=require('../../hooks/useCommunity');const usePoll_1=require('../../hooks/usePoll');const ProposalTableRowStatusBadge_1=require('../../components/ProposalTableRowStatusBadge');const BackButton_1=require('../../../components/BackButton');const lite_services_1=require('../../../../../services/services/lite/lite-services');const PageContainer=(0,core_1.styled)('div')({marginBottom:50,width:'1000px',height:'100%',margin:'auto',padding:'28px 0',boxSizing:'border-box',paddingTop:0,['@media (max-width: 1425px)']:{},['@media (max-width:1335px)']:{},['@media (max-width:1167px)']:{width:'86vw'},['@media (max-width:1030px)']:{},['@media (max-width:960px)']:{},['@media (max-width:645px)']:{flexDirection:'column'}});const ProposalDetails=({id})=>{const {proposalId}=(0,react_router_dom_1.useParams)();const theme=(0,core_1.useTheme)();const isMobileSmall=(0,core_1.useMediaQuery)(theme.breakpoints.down('sm'));const navigate=(0,react_router_dom_1.useHistory)();const {state}=(0,react_router_dom_1.useLocation)();const {account,wallet}=(0,useTezos_1.useTezos)();const openNotification=(0,useNotification_1.useNotification)();const [refresh,setRefresh]=(0,react_1.useState)();const community=(0,useCommunity_1.useCommunity)(id);const poll=(0,usePoll_1.useSinglePoll)(proposalId,id,community);const choices=(0,usePollChoices_1.usePollChoices)(poll,refresh);const [selectedVotes,setSelectedVotes]=(0,react_1.useState)([]);(0,react_1.useEffect)(()=>{choices.map(elem=>{return elem.selected=false;});});const votesData=selectedVotes.map(vote=>{return{address:account,choice:vote===null||vote===void 0?void 0:vote.name,choiceId:vote===null||vote===void 0?void 0:vote._id,pollID:poll===null||poll===void 0?void 0:poll._id};});const saveVote=()=>__awaiter(void 0,void 0,void 0,function*(){var _a;if(!wallet){return;}try{const publicKey=(_a=yield wallet===null||wallet===void 0?void 0:wallet.client.getActiveAccount())===null||_a===void 0?void 0:_a.publicKey;const {signature,payloadBytes}=yield(0,utils_1.getSignature)(account,wallet,JSON.stringify(votesData));if(!signature){openNotification({message:`Issue with Signature`,autoHideDuration:3000,variant:'error'});return;}const resp=yield(0,lite_services_1.voteOnLiteProposal)(signature,publicKey,payloadBytes);if(resp.ok){openNotification({message:'Your vote has been submitted',autoHideDuration:3000,variant:'success'});setRefresh(Math.random());setSelectedVotes([]);}else{openNotification({message:`Something went wrong!!`,autoHideDuration:3000,variant:'error'});return;}}catch(error){openNotification({message:`Something went wrong!!`,autoHideDuration:3000,variant:'error'});return;}});return(0,jsx_runtime_1.jsxs)(PageContainer,{style:{gap:30},children:[(0,jsx_runtime_1.jsx)(core_1.Grid,{container:true,children:(0,jsx_runtime_1.jsx)(BackButton_1.BackButton,{})}),(0,jsx_runtime_1.jsxs)(core_1.Grid,{container:true,style:{gap:30},children:[(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,children:(0,jsx_runtime_1.jsx)(ProposalDetailCard_1.ProposalDetailCard,{poll:poll,daoId:id})}),(0,jsx_runtime_1.jsx)(core_1.Grid,{container:true,item:true,xs:12,children:choices&&choices.length>0?(0,jsx_runtime_1.jsxs)(GridContainer_1.GridContainer,{container:true,style:{gap:32},direction:'row',justifyContent:'center',children:[(0,jsx_runtime_1.jsx)(core_1.Grid,{container:true,item:true,justifyContent:isMobileSmall?'center':'space-between',direction:'row',style:{gap:30},children:choices.map((choice,index)=>{return(0,jsx_runtime_1.jsx)(ChoiceItemSelected_1.ChoiceItemSelected,{multiple:(poll===null||poll===void 0?void 0:poll.votingStrategy)===0?false:true,choice:choice,votes:selectedVotes,setSelectedVotes:setSelectedVotes},index);})}),(poll===null||poll===void 0?void 0:poll.isActive)===ProposalTableRowStatusBadge_1.ProposalStatus.ACTIVE?(0,jsx_runtime_1.jsx)(core_1.Button,{disabled:selectedVotes.length===0,variant:'contained',color:'secondary',onClick:()=>saveVote(),children:'Cast your vote'}):null]}):null}),(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,xs:12,children:poll&&poll!==undefined?(0,jsx_runtime_1.jsx)(VoteDetails_1.VoteDetails,{poll:poll,choices:choices,token:community===null||community===void 0?void 0:community.tokenAddress,communityId:community===null||community===void 0?void 0:community._id}):null})]})]});};exports.ProposalDetails=ProposalDetails;