'use strict';var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){function adopt(value){return value instanceof P?value:new P(function(resolve){resolve(value);});}return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value));}catch(e){reject(e);}}function rejected(value){try{step(generator['throw'](value));}catch(e){reject(e);}}function step(result){result.done?resolve(result.value):adopt(result.value).then(fulfilled,rejected);}step((generator=generator.apply(thisArg,_arguments||[])).next());});};var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{'default':mod};};Object.defineProperty(exports,'__esModule',{value:true});exports.ProposalCreator=exports.ProposalForm=void 0;const jsx_runtime_1=require('react/jsx-runtime');const react_1=require('react');const core_1=require('@material-ui/core');const Choices_1=require('../../components/Choices');const react_router_dom_1=require('react-router-dom');const formik_1=require('formik');const formik_material_ui_1=require('formik-material-ui');const useTezos_1=require('../../../../../services/beacon/hooks/useTezos');const utils_1=require('../../../../../services/lite/utils');const dayjs_1=__importDefault(require('dayjs'));const useNotification_1=require('../../../../common/hooks/useNotification');const duration_1=__importDefault(require('dayjs/plugin/duration'));const CommunityBadge_1=require('../../components/CommunityBadge');const BackButton_1=require('../../../components/BackButton');const lite_services_1=require('../../../../../services/services/lite/lite-services');const useToken_1=require('../../hooks/useToken');const useDAO_1=require('../../../../../services/services/dao/hooks/useDAO');const router_1=require('../../../../explorer/pages/DAO/router');dayjs_1.default.extend(duration_1.default);const ProposalContainer=(0,core_1.styled)(core_1.Grid)(({theme})=>({boxSizing:'border-box',[theme.breakpoints.down('md')]:{marginTop:30}}));const CustomFormikTextField=(0,core_1.withStyles)({root:{'& .MuiInput-root':{fontWeight:300,textAlign:'initial'},'& .MuiInputBase-input':{textAlign:'initial',paddingTop:19,paddingLeft:26,borderRadius:4,paddingBottom:19,fontSize:18,background:'#2f3438'},'& .MuiInput-underline:before':{borderBottom:'none !important'},'& .MuiInput-underline:hover:before':{borderBottom:'none !important'},'& .MuiInput-underline:after':{borderBottom:'none !important'}},disabled:{}})(formik_material_ui_1.TextField);const PageContainer=(0,core_1.styled)('div')({height:'100%',margin:'auto',padding:'28px 0',boxSizing:'border-box',paddingTop:0,['@media (max-width: 1425px)']:{},['@media (max-width:1335px)']:{},['@media (max-width:1167px)']:{width:'78vw'},['@media (max-width:1030px)']:{},['@media (max-width:960px)']:{},['@media (max-width:645px)']:{flexDirection:'column'}});const Header=(0,core_1.styled)(core_1.Grid)(({theme})=>({[theme.breakpoints.down('sm')]:{marginBottom:6}}));const ProposalChoices=(0,core_1.styled)(core_1.Grid)({flexGrow:1});const CustomTextarea=(0,core_1.styled)((0,core_1.withTheme)(core_1.TextareaAutosize))(props=>({'minHeight':117,'boxSizing':'border-box','width':'100%','fontWeight':300,'paddingTop':19,'paddingLeft':26,'border':'none','fontSize':17,'color':props.theme.palette.text.primary,'background':props.theme.palette.primary.main,'borderRadius':4,'paddingRight':40,'wordBreak':'break-word','fontFamily':'Roboto Mono','&:focus-visible':{outline:'none'},'resize':'none'}));const CommunityLabel=(0,core_1.styled)(core_1.Grid)({minWidth:212,height:54,background:'#2F3438',borderRadius:4,display:'inline-grid',marginBottom:25,width:'fit-content',padding:12});const ErrorText=(0,core_1.styled)(core_1.Typography)({fontSize:14,color:'red',marginBottom:-21,marginTop:2});const ErrorTextTime=(0,core_1.styled)(core_1.Typography)({marginTop:-18,marginBottom:0,fontSize:14,color:'red'});const ErrorTextChoices=(0,core_1.styled)(core_1.Typography)({fontSize:14,color:'red',marginBottom:-21,marginTop:-86});const TimeBox=(0,core_1.styled)(core_1.Grid)(({theme})=>({background:theme.palette.primary.main,borderRadius:8,width:72,minHeight:59,marginBottom:16,display:'grid',[theme.breakpoints.down('sm')]:{'width':172,'& input':{marginLeft:'30%'}}}));const TimeContainer=(0,core_1.styled)(core_1.Grid)(({theme})=>({alignItems:'baseline',marginTop:0,gap:10,[theme.breakpoints.down('md')]:{marginTop:30}}));const TimeContainerMobile=(0,core_1.styled)(core_1.Grid)(({theme})=>({alignItems:'baseline',marginTop:0,gap:10,[theme.breakpoints.down('md')]:{marginTop:30,display:'grid'}}));const hasDuplicates=options=>{const trimOptions=options.map(option=>option.trim());return new Set(trimOptions).size!==trimOptions.length;};const validateForm=values=>{const errors={};if(!values.name){errors.name='Required';}if(!values.externalLink){errors.externalLink='Required';}if(values.choices.length===0||values.choices.length===1){errors.choices='Two options at least are required';}if(values.choices.length>0&&values.choices.includes('')){errors.choices='Please enter an option value';}if(values.choices.length>0&&hasDuplicates(values.choices)){errors.choices='Duplicate options are not allowed';}if(values.endTimeMinutes!==undefined&&values.endTimeDays!==undefined&&values.endTimeHours!==undefined){if(values.endTimeMinutes!==null&&values.endTimeDays!==null&&values.endTimeHours!==null){if(values.endTimeMinutes<5&&values.endTimeDays===0&&values.endTimeHours===0){errors.endTimeMinutes=`Can't allow less than 5 minutes for voting`;}}}if(values.endTimeDays===null||values.endTimeDays===undefined){errors.endTimeDays='Required';}if(values.endTimeDays&&values.endTimeDays<0){errors.endTimeDays='Most be greater than zero';}if(values.endTimeHours===null||values.endTimeHours===undefined){errors.endTimeDays='Required';}if(values.endTimeHours&&values.endTimeHours<0){errors.endTimeDays='Most be greater than zero';}if(values.endTimeMinutes===null||values.endTimeMinutes===undefined){errors.endTimeDays='Required';}if(values.endTimeMinutes&&values.endTimeMinutes<0){errors.endTimeDays='Most be greater than zero';}return errors;};const ProposalForm=({submitForm,values,setFieldValue,errors,touched,isSubmitting,setFieldTouched,id})=>{const theme=(0,core_1.useTheme)();const isMobileSmall=(0,core_1.useMediaQuery)(theme.breakpoints.down('sm'));const finalDate=calculateEndTime((0,formik_1.getIn)(values,'endTimeDays'),(0,formik_1.getIn)(values,'endTimeHours'),(0,formik_1.getIn)(values,'endTimeMinutes'));const {pathname}=(0,react_router_dom_1.useLocation)();const shouldShowBar=pathname.includes('/lite')?true:false;const hasErrors=errors.endTimeDays||errors.endTimeHours||errors.endTimeMinutes;return(0,jsx_runtime_1.jsx)(PageContainer,{style:shouldShowBar?{width:'1000px'}:{width:'100%'},children:(0,jsx_runtime_1.jsxs)(core_1.Grid,{container:true,children:[shouldShowBar?(0,jsx_runtime_1.jsxs)(jsx_runtime_1.Fragment,{children:[(0,jsx_runtime_1.jsx)(BackButton_1.BackButton,{}),(0,jsx_runtime_1.jsxs)(Header,{container:true,direction:'column',children:[(0,jsx_runtime_1.jsx)(CommunityLabel,{container:true,direction:'row',justifyContent:'center',alignItems:'center',children:(0,jsx_runtime_1.jsx)(CommunityBadge_1.CommunityBadge,{id:id})}),(0,jsx_runtime_1.jsx)(core_1.Typography,{color:'textPrimary',variant:'subtitle1',style:isMobileSmall?{marginBottom:0}:{marginBottom:32},children:'New Proposal'})]})]}):null,(0,jsx_runtime_1.jsxs)(core_1.Grid,{container:true,direction:isMobileSmall?'row':'column',style:{gap:40},children:[(0,jsx_runtime_1.jsxs)(ProposalContainer,{container:true,item:true,direction:'column',style:{gap:30},xs:12,md:7,lg:8,children:[(0,jsx_runtime_1.jsxs)(core_1.Grid,{item:true,children:[(0,jsx_runtime_1.jsx)(formik_1.Field,{name:'name',type:'text',placeholder:'Proposal Title*',component:CustomFormikTextField}),(errors===null||errors===void 0?void 0:errors.name)&&touched.name?(0,jsx_runtime_1.jsx)(ErrorText,{children:errors.name}):null]}),(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,children:(0,jsx_runtime_1.jsx)(formik_1.Field,{name:'description',children:()=>(0,jsx_runtime_1.jsx)(CustomTextarea,{maxLength:1500,'aria-label':'empty textarea',placeholder:'Short description',value:(0,formik_1.getIn)(values,'description'),onChange:newValue=>{setFieldValue('description',newValue.target.value);}})})}),(0,jsx_runtime_1.jsxs)(core_1.Grid,{item:true,children:[(0,jsx_runtime_1.jsx)(formik_1.Field,{name:'externalLink',type:'text',placeholder:'External Link',component:CustomFormikTextField}),(errors===null||errors===void 0?void 0:errors.externalLink)&&touched.externalLink?(0,jsx_runtime_1.jsx)(ErrorText,{children:errors.externalLink}):null]}),isMobileSmall?(0,jsx_runtime_1.jsxs)(TimeContainerMobile,{direction:'row',children:[(0,jsx_runtime_1.jsx)(TimeBox,{item:true,children:(0,jsx_runtime_1.jsx)(formik_1.Field,{style:{margin:'auto'},id:'outlined-basic',name:'endTimeDays',type:'number',placeholder:'DD',component:CustomFormikTextField,inputProps:{min:0},onClick:()=>{if((0,formik_1.getIn)(values,'endTimeDays')===0){setFieldValue('endTimeDays','');setFieldTouched('endTimeDays');}},onChange:newValue=>{if(newValue.target.value===''){setFieldValue('endTimeDays',null);}else{setFieldValue('endTimeDays',parseInt(newValue.target.value,10));}}})}),(0,jsx_runtime_1.jsx)(TimeBox,{item:true,children:(0,jsx_runtime_1.jsx)(formik_1.Field,{style:{margin:'auto'},id:'outlined-basic',name:'endTimeHours',type:'number',placeholder:'HH',component:CustomFormikTextField,inputProps:{min:0},onClick:()=>{if((0,formik_1.getIn)(values,'endTimeHours')===0){setFieldValue('endTimeHours','');}},onChange:newValue=>{if(newValue.target.value===''){setFieldValue('endTimeHours',null);}else{setFieldValue('endTimeHours',parseInt(newValue.target.value,10));}}})}),(0,jsx_runtime_1.jsx)(TimeBox,{item:true,children:(0,jsx_runtime_1.jsx)(formik_1.Field,{style:{margin:'auto'},id:'outlined-basic',name:'endTimeMinutes',type:'number',placeholder:'MM',component:CustomFormikTextField,inputProps:{min:0},onClick:()=>{if((0,formik_1.getIn)(values,'endTimeMinutes')===0){setFieldValue('endTimeMinutes','');}},onChange:newValue=>{if(newValue.target.value===''){setFieldValue('endTimeMinutes',null);}else{setFieldValue('endTimeMinutes',parseInt(newValue.target.value,10));}}})}),(0,formik_1.getIn)(values,'endTimeDays')!==null&&(0,formik_1.getIn)(values,'endTimeHours')!==null&&(0,formik_1.getIn)(values,'endTimeMinutes')!==null&&!hasErrors?(0,jsx_runtime_1.jsxs)(core_1.Grid,{container:true,direction:'row',children:[(0,jsx_runtime_1.jsx)(core_1.Typography,{color:'textPrimary',variant:'body2',children:'End date:'}),(0,jsx_runtime_1.jsxs)(core_1.Typography,{color:'secondary',variant:'body2',style:{marginLeft:10},children:[' ',(0,dayjs_1.default)(Number(finalDate)).format('MM/DD/YYYY h:mm A')]})]}):null,(0,jsx_runtime_1.jsx)(core_1.Grid,{container:true,direction:'row',children:(errors===null||errors===void 0?void 0:errors.endTimeDays)&&touched.endTimeDays?(0,jsx_runtime_1.jsx)(ErrorTextTime,{children:errors.endTimeDays}):null})]}):null,(0,jsx_runtime_1.jsxs)(ProposalChoices,{children:[(0,jsx_runtime_1.jsx)(Choices_1.Choices,{choices:(0,formik_1.getIn)(values,'choices'),isLoading:isSubmitting,submitForm:submitForm,votingStrategy:(0,formik_1.getIn)(values,'votingStrategy'),setFieldValue:setFieldValue}),(errors===null||errors===void 0?void 0:errors.choices)&&touched.choices?(0,jsx_runtime_1.jsx)(ErrorTextChoices,{children:errors.choices}):null]})]}),!isMobileSmall?(0,jsx_runtime_1.jsxs)(TimeContainer,{container:true,item:true,direction:'row',style:{gap:10},xs:12,md:4,lg:4,children:[(0,jsx_runtime_1.jsx)(TimeBox,{item:true,children:(0,jsx_runtime_1.jsx)(formik_1.Field,{style:{margin:'auto'},id:'outlined-basic',name:'endTimeDays',type:'number',placeholder:'DD',component:CustomFormikTextField,inputProps:{min:0},onClick:()=>{if((0,formik_1.getIn)(values,'endTimeDays')===0){setFieldValue('endTimeDays','');setFieldTouched('endTimeDays');}},onChange:newValue=>{if(newValue.target.value===''){setFieldValue('endTimeDays',null);}else{setFieldValue('endTimeDays',parseInt(newValue.target.value,10));}}})}),(0,jsx_runtime_1.jsx)(TimeBox,{item:true,children:(0,jsx_runtime_1.jsx)(formik_1.Field,{style:{margin:'auto'},id:'outlined-basic',name:'endTimeHours',type:'number',placeholder:'HH',component:CustomFormikTextField,inputProps:{min:0},onClick:()=>{if((0,formik_1.getIn)(values,'endTimeHours')===0){setFieldValue('endTimeHours','');}},onChange:newValue=>{if(newValue.target.value===''){setFieldValue('endTimeHours',null);}else{setFieldValue('endTimeHours',parseInt(newValue.target.value,10));}}})}),(0,jsx_runtime_1.jsx)(TimeBox,{item:true,children:(0,jsx_runtime_1.jsx)(formik_1.Field,{style:{margin:'auto'},id:'outlined-basic',name:'endTimeMinutes',type:'number',placeholder:'MM',component:CustomFormikTextField,inputProps:{min:0},onClick:()=>{if((0,formik_1.getIn)(values,'endTimeMinutes')===0){setFieldValue('endTimeMinutes','');}},onChange:newValue=>{if(newValue.target.value===''){setFieldValue('endTimeMinutes',null);}else{setFieldValue('endTimeMinutes',parseInt(newValue.target.value,10));}}})}),(0,formik_1.getIn)(values,'endTimeDays')!==null&&(0,formik_1.getIn)(values,'endTimeHours')!==null&&(0,formik_1.getIn)(values,'endTimeMinutes')!==null&&!hasErrors?(0,jsx_runtime_1.jsxs)(core_1.Grid,{container:true,direction:'row',style:{marginTop:-70},children:[(0,jsx_runtime_1.jsx)(core_1.Typography,{color:'textPrimary',variant:'body2',children:'End date:'}),(0,jsx_runtime_1.jsxs)(core_1.Typography,{color:'secondary',variant:'body2',style:{marginLeft:10},children:[' ',(0,dayjs_1.default)(Number(finalDate)).format('MM/DD/YYYY h:mm A')]})]}):null,(0,jsx_runtime_1.jsx)(core_1.Grid,{container:true,direction:'row',style:{marginTop:-80},children:(errors===null||errors===void 0?void 0:errors.endTimeDays)&&touched.endTimeDays?(0,jsx_runtime_1.jsx)(ErrorTextTime,{children:errors.endTimeDays}):null})]}):null]})]})});};exports.ProposalForm=ProposalForm;const calculateEndTime=(days,hours,minutes)=>{const time=(0,dayjs_1.default)().add(days,'days').add(hours,'hours').add(minutes,'minutes');return String(time.valueOf());};const ProposalCreator=props=>{var _a,_b;const navigate=(0,react_router_dom_1.useHistory)();const {network,account,wallet}=(0,useTezos_1.useTezos)();const openNotification=(0,useNotification_1.useNotification)();const [isLoading,setIsLoading]=(0,react_1.useState)(false);const daoId=(0,router_1.useDAOID)();const {data}=(0,useDAO_1.useDAO)(daoId);const id=((_a=data===null||data===void 0?void 0:data.liteDAOData)===null||_a===void 0?void 0:_a._id)?(_b=data===null||data===void 0?void 0:data.liteDAOData)===null||_b===void 0?void 0:_b._id:props.id;const tokenAddress=(0,useToken_1.useToken)(id);const initialState={name:'',description:'',externalLink:'',choices:[''],startTime:(0,dayjs_1.default)().toISOString(),endTime:'',daoID:'',author:account,votingStrategy:0,endTimeDays:null,endTimeHours:null,endTimeMinutes:null};const saveProposal=(0,react_1.useCallback)(values=>__awaiter(void 0,void 0,void 0,function*(){var _c;try{setIsLoading(true);if(!wallet){return;}const data=values;data.daoID=id;data.startTime=String((0,dayjs_1.default)().valueOf());data.endTime=calculateEndTime(values.endTimeDays,values.endTimeHours,values.endTimeMinutes);const {signature,payloadBytes}=yield(0,utils_1.getSignature)(account,wallet,JSON.stringify(data));const publicKey=(_c=yield wallet===null||wallet===void 0?void 0:wallet.client.getActiveAccount())===null||_c===void 0?void 0:_c.publicKey;if(!signature){openNotification({message:`Issue with Signature`,autoHideDuration:3000,variant:'error'});return;}const res=yield(0,lite_services_1.saveLiteProposal)(signature,publicKey,payloadBytes);if(res.ok){openNotification({message:'Proposal created!',autoHideDuration:3000,variant:'success'});setIsLoading(false);daoId?navigate.push(`/explorer/dao/${daoId}/proposals`):navigate.push(`/explorer/lite/dao/${id}/community`);}else{openNotification({message:'Proposal could not be created',autoHideDuration:3000,variant:'error'});setIsLoading(false);return;}}catch(error){openNotification({message:'Proposal could not be created',autoHideDuration:3000,variant:'error'});setIsLoading(false);return;}}),[navigate,id,network,tokenAddress]);return(0,jsx_runtime_1.jsx)(PageContainer,{style:{width:'100%'},children:(0,jsx_runtime_1.jsx)(core_1.Grid,{container:true,direction:'column',style:{gap:18},children:(0,jsx_runtime_1.jsx)(formik_1.Formik,{validateOnChange:true,validateOnBlur:false,validate:validateForm,onSubmit:saveProposal,initialValues:initialState,children:({submitForm,setFieldValue,values,errors,touched,setFieldTouched})=>{return(0,jsx_runtime_1.jsx)(formik_1.Form,{style:{width:'100%'},children:(0,jsx_runtime_1.jsx)(exports.ProposalForm,{submitForm:submitForm,isSubmitting:isLoading,setFieldValue:setFieldValue,errors:errors,touched:touched,values:values,setFieldTouched:setFieldTouched,id:id})});}})})});};exports.ProposalCreator=ProposalCreator;