'use strict';var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){function adopt(value){return value instanceof P?value:new P(function(resolve){resolve(value);});}return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value));}catch(e){reject(e);}}function rejected(value){try{step(generator['throw'](value));}catch(e){reject(e);}}function step(result){result.done?resolve(result.value):adopt(result.value).then(fulfilled,rejected);}step((generator=generator.apply(thisArg,_arguments||[])).next());});};var __importDefault=this&&this.__importDefault||function(mod){return mod&&mod.__esModule?mod:{'default':mod};};Object.defineProperty(exports,'__esModule',{value:true});exports.ProposalList=exports.StyledDivider=exports.ProposalPopularity=void 0;const jsx_runtime_1=require('react/jsx-runtime');const react_1=require('react');const core_1=require('@material-ui/core');const ProposalTableRow_1=require('./ProposalTableRow');const ProposalTableRowStatusBadge_1=require('./ProposalTableRowStatusBadge');const useNotification_1=require('../../../common/hooks/useNotification');const Dropdown_1=require('../../../explorer/components/Dropdown');const config_1=require('../../../../services/config');const node_fetch_1=__importDefault(require('node-fetch'));var ProposalPopularity;(function(ProposalPopularity){ProposalPopularity['RECENT']='recent';ProposalPopularity['POPULAR']='popular';}(ProposalPopularity||(exports.ProposalPopularity=ProposalPopularity={})));const ProposalListContainer=(0,core_1.styled)(core_1.Grid)(({theme})=>({background:theme.palette.primary.main,borderRadius:8}));const Header=(0,core_1.styled)(core_1.Grid)({padding:'24px 41px'});exports.StyledDivider=(0,core_1.styled)(core_1.Divider)({height:0.3,backgroundColor:'#7d8c8b',marginTop:0,marginBottom:0});const NoProposalsText=(0,core_1.styled)(core_1.Typography)({paddingTop:20,paddingBottom:20});const Title=(0,core_1.styled)(core_1.Typography)(({theme})=>({[theme.breakpoints.down('sm')]:{marginBottom:14,fontSize:16,marginLeft:-2}}));const ProposalList=({polls,id})=>{const communityId=id===null||id===void 0?void 0:id.toString();const openNotification=(0,useNotification_1.useNotification)();const [communityPolls,setCommunityPolls]=(0,react_1.useState)();const [isFilter,setIsFilter]=(0,react_1.useState)(false);const [isFilterByStatus,setIsFilterByStatus]=(0,react_1.useState)(1);const [statusFilter,setStatusFilter]=(0,react_1.useState)('');const theme=(0,core_1.useTheme)();const isMobileSmall=(0,core_1.useMediaQuery)(theme.breakpoints.down('sm'));(0,react_1.useEffect)(()=>{setCommunityPolls(polls);},[polls]);(0,react_1.useMemo)(()=>{function getPollToken(){return __awaiter(this,void 0,void 0,function*(){if(polls&&polls.length>0){polls.forEach(poll=>__awaiter(this,void 0,void 0,function*(){yield(0,node_fetch_1.default)(`${(0,config_1.getEnv)(config_1.EnvKey.REACT_APP_LITE_API_URL)}/token/${communityId}`).then(response=>__awaiter(this,void 0,void 0,function*(){if(!response.ok){openNotification({message:'An error has occurred',autoHideDuration:2000,variant:'error'});return;}const record=yield response.json();if(!record){return;}poll.tokenAddress=record.tokenAddress;poll.tokenSymbol=record.symbol;poll.tokenDecimals=record.decimals;return;}));}));}});}getPollToken();return;},[polls,communityId]);const filterProposals=status=>{setStatusFilter(status);if(status==='all'){setIsFilterByStatus(Math.random());if(isFilter){sortByPopularity;return;}setCommunityPolls(polls);return;}if(status!=='all'){setIsFilterByStatus(Math.random());if(isFilter){sortByPopularity;return;}const formatted=polls.filter(poll=>poll.isActive===status);setCommunityPolls(formatted);}};const filterProposalByPopularity=status=>{status===ProposalPopularity.RECENT?setIsFilter(false):setIsFilter(true);};const sortByRecent=(0,react_1.useMemo)(()=>{if(!isFilter){if(!isFilterByStatus||statusFilter===''){setCommunityPolls(polls);setIsFilter(false);}else{if(statusFilter!=='all'){const formatted=polls.filter(poll=>poll.isActive===statusFilter);setCommunityPolls(formatted);}else{setCommunityPolls(polls);}setIsFilter(false);}}},[isFilter,statusFilter]);const sortByPopularity=(0,react_1.useMemo)(status=>{if(isFilter){if(status!==ProposalTableRowStatusBadge_1.ProposalStatus.ACTIVE&&status!==ProposalTableRowStatusBadge_1.ProposalStatus.CLOSED&&status!==undefined){const formatted=polls.slice().sort((a,b)=>(a.votes&&a.votes>0?a.votes:0)>(b.votes&&b.votes>0?b.votes:0)?-1:1);setCommunityPolls(formatted);setIsFilter(true);}else{let formatted;if(statusFilter==='all'||statusFilter===''){formatted=polls;}else{formatted=polls.filter(poll=>poll.isActive===statusFilter);}setCommunityPolls(formatted);const formattedByPopularity=formatted.slice().sort((a,b)=>(a.votes&&a.votes>0?a.votes:0)>(b.votes&&b.votes>0?b.votes:0)?-1:1);setCommunityPolls(formattedByPopularity);setIsFilter(true);}}},[isFilter,statusFilter]);return(0,jsx_runtime_1.jsxs)(ProposalListContainer,{container:true,direction:'column',children:[(0,jsx_runtime_1.jsxs)(Header,{container:true,justifyContent:'space-between',alignItems:'center',children:[(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,xs:isMobileSmall?12:3,children:(0,jsx_runtime_1.jsx)(Title,{variant:'body2',color:'textPrimary',children:'Off-Chain'})}),(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,xs:isMobileSmall?6:4,container:true,direction:'row',justifyContent:'flex-end',children:(0,jsx_runtime_1.jsx)(Dropdown_1.Dropdown,{options:[{name:'Most recent',value:'recent'},{name:'Most popular',value:'popular'}],value:'recent',onSelected:filterProposalByPopularity})}),(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,xs:isMobileSmall?6:3,container:true,direction:'row',justifyContent:'flex-end',children:(0,jsx_runtime_1.jsx)(Dropdown_1.Dropdown,{options:[{name:'All',value:'all'},{name:'Active',value:'active'},{name:'Closed',value:'closed'}],value:'all',onSelected:filterProposals})})]}),(0,jsx_runtime_1.jsx)(exports.StyledDivider,{}),communityPolls&&communityPolls.length>0?communityPolls.map((poll,i)=>{return(0,jsx_runtime_1.jsxs)('div',{children:[(0,jsx_runtime_1.jsx)(ProposalTableRow_1.ProposalTableRow,{poll:poll}),communityPolls.length-1!==i?(0,jsx_runtime_1.jsx)(exports.StyledDivider,{},`divider-${i}`):null]},`poll-${i}`);}):(0,jsx_runtime_1.jsx)(Header,{children:(0,jsx_runtime_1.jsx)(NoProposalsText,{color:'textPrimary',children:'No proposals'})})]});};exports.ProposalList=ProposalList;