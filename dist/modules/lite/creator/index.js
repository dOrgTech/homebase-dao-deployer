'use strict';var __awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){function adopt(value){return value instanceof P?value:new P(function(resolve){resolve(value);});}return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value));}catch(e){reject(e);}}function rejected(value){try{step(generator['throw'](value));}catch(e){reject(e);}}function step(result){result.done?resolve(result.value):adopt(result.value).then(fulfilled,rejected);}step((generator=generator.apply(thisArg,_arguments||[])).next());});};Object.defineProperty(exports,'__esModule',{value:true});exports.CommunityCreator=void 0;const jsx_runtime_1=require('react/jsx-runtime');const react_1=require('react');const core_1=require('@material-ui/core');const UploadAvatar_1=require('./components/UploadAvatar');const formik_1=require('formik');const formik_material_ui_1=require('formik-material-ui');const react_router_1=require('react-router');const utils_1=require('@taquito/utils');const useTokenMetadata_1=require('../../../services/contracts/baseDAO/hooks/useTokenMetadata');const useNotification_1=require('../../common/hooks/useNotification');const useTezos_1=require('../../../services/beacon/hooks/useTezos');const utils_2=require('../../../services/utils/utils');const Toolbar_1=require('../../common/Toolbar');const SmallButton_1=require('../../common/SmallButton');const lite_services_1=require('../../../services/services/lite/lite-services');const icons_1=require('@material-ui/icons');const CommunityContainer=(0,core_1.styled)(core_1.Grid)(({theme})=>({boxSizing:'border-box',padding:'0px 15px',[theme.breakpoints.down('md')]:{marginTop:0}}));const InfoIconInput=(0,core_1.styled)(icons_1.InfoRounded)(({theme})=>({cursor:'default',color:theme.palette.secondary.light,height:16,width:16}));const AvatarCommunityContainer=(0,core_1.styled)(core_1.Grid)(({theme})=>({boxSizing:'border-box',padding:'0px 15px',[theme.breakpoints.down('sm')]:{marginTop:30}}));const CommunityContainerBottom=(0,core_1.styled)(core_1.Grid)(({theme})=>({boxSizing:'border-box',padding:'0px 15px',[theme.breakpoints.down('sm')]:{marginTop:30,gap:12},marginTop:30}));const TitleContainer=(0,core_1.styled)(core_1.Grid)(({theme})=>({boxSizing:'border-box',padding:'0px 15px',[theme.breakpoints.down('md')]:{marginTop:0},marginBottom:26}));const AvatarContainer=(0,core_1.styled)(core_1.Grid)({height:'100%'});const PageContent=(0,core_1.styled)(core_1.Grid)({width:'1000px',height:'100%',margin:'auto',padding:'28px 0',flexDirection:'row',paddingTop:0,['@media (max-width:1167px)']:{width:'86vw'}});const CustomFormikTextField=(0,core_1.withStyles)({root:{'& .MuiInput-root':{fontWeight:300,textAlign:'initial'},'& .MuiInputBase-input':{textAlign:'initial'},'& .MuiInput-underline:before':{borderBottom:'none !important'},'& .MuiInput-underline:hover:before':{borderBottom:'none !important'},'& .MuiInput-underline:after':{borderBottom:'none !important'}}})(formik_material_ui_1.TextField);const CustomTextarea=(0,core_1.styled)((0,core_1.withTheme)(core_1.TextareaAutosize))(props=>({'minHeight':152,'boxSizing':'border-box','width':'100%','fontWeight':400,'padding':'21px 20px','fontFamily':'Roboto Mono','border':'none','fontSize':16,'color':props.theme.palette.text.secondary,'background':props.theme.palette.primary.dark,'borderRadius':8,'paddingRight':40,'wordBreak':'break-word','&:focus-visible':{outline:'none'},'resize':'none'}));const CustomSelect=(0,core_1.styled)(formik_1.Field)(({theme})=>({width:'100%',background:theme.palette.primary.dark,border:'none',color:theme.palette.text.secondary,fontFamily:'Roboto Mono',fontSize:18,borderRight:'26px solid transparent',borderRadius:4,minHeight:52}));const ErrorText=(0,core_1.styled)(core_1.Typography)({fontSize:14,color:'red',marginBottom:-21,marginTop:-16});const PageContainer=(0,core_1.styled)(core_1.Grid)(({theme})=>({background:theme.palette.primary.main}));const CustomInputContainer=(0,core_1.styled)(core_1.Grid)(({theme})=>({height:54,boxSizing:'border-box',background:theme.palette.primary.dark,borderRadius:8,alignItems:'center',display:'flex',padding:'13px 23px',width:'100%'}));const CheckboxContainer=(0,core_1.styled)(core_1.Grid)(({theme})=>({[theme.breakpoints.down('xs')]:{maxWidth:'16.666667%',flexBasis:'16.666667%'},maxwidth:'5%',flexBasis:'5%'}));const validateForm=values=>{const errors={};if(!values.name){errors.name='Required';}if(!values.tokenAddress){errors.tokenAddress='Required';}if(values.tokenAddress&&(0,utils_1.validateContractAddress)(values.tokenAddress)!==3){errors.tokenAddress='Invalid address';}return errors;};const CommunityForm=({submitForm,values,setFieldValue,errors,touched,setFieldTouched,isSubmitting})=>{const theme=(0,core_1.useTheme)();const isMobileSmall=(0,core_1.useMediaQuery)(theme.breakpoints.down('sm'));const {data:tokenMetadata,isLoading:loading,error}=(0,useTokenMetadata_1.useTokenMetadata)(values===null||values===void 0?void 0:values.tokenAddress);(0,react_1.useEffect)(()=>{if(tokenMetadata){setFieldValue('tokenID',tokenMetadata.token_id);setFieldValue('tokenType',tokenMetadata.standard);setFieldValue('symbol',tokenMetadata.symbol);setFieldValue('decimals',tokenMetadata.decimals);}if(error){setFieldValue('tokenID',undefined);setFieldValue('tokenType',undefined);setFieldValue('symbol',undefined);}},[error,setFieldValue,tokenMetadata]);return(0,jsx_runtime_1.jsxs)(PageContainer,{container:true,direction:'row',children:[(0,jsx_runtime_1.jsx)(Toolbar_1.Navbar,{mode:'creator'}),(0,jsx_runtime_1.jsxs)(PageContent,{container:true,children:[(0,jsx_runtime_1.jsx)(TitleContainer,{container:true,direction:'row',children:(0,jsx_runtime_1.jsx)(core_1.Typography,{variant:'h3',color:'textSecondary',children:'Create a Community'})}),(0,jsx_runtime_1.jsxs)(CommunityContainer,{container:true,item:true,direction:'column',style:{gap:22},xs:12,md:6,lg:9,children:[(0,jsx_runtime_1.jsx)(CustomInputContainer,{item:true,children:(0,jsx_runtime_1.jsx)(formik_1.Field,{name:'name',type:'text',placeholder:'Community Name*',component:CustomFormikTextField})}),(errors===null||errors===void 0?void 0:errors.name)&&touched.name?(0,jsx_runtime_1.jsx)(ErrorText,{children:errors.name}):null,(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,children:(0,jsx_runtime_1.jsx)(formik_1.Field,{name:'description',children:()=>(0,jsx_runtime_1.jsx)(CustomTextarea,{disabled:isSubmitting,maxLength:1500,'aria-label':'empty textarea',placeholder:'Short description',value:(0,formik_1.getIn)(values,'description'),onChange:newValue=>{setFieldValue('description',newValue.target.value);}})})}),(0,jsx_runtime_1.jsx)(CustomInputContainer,{item:true,children:(0,jsx_runtime_1.jsx)(formik_1.Field,{name:'linkToTerms',type:'text',placeholder:'Link to Terms',component:CustomFormikTextField})}),(0,jsx_runtime_1.jsx)(CustomInputContainer,{item:true,children:(0,jsx_runtime_1.jsx)(formik_1.Field,{onClick:()=>setFieldTouched('tokenAddress'),name:'tokenAddress',type:'text',placeholder:'Token Contract Address*',component:CustomFormikTextField})}),tokenMetadata&&!loading&&(0,jsx_runtime_1.jsx)(core_1.Typography,{variant:'subtitle2',color:'secondary',style:{marginTop:-16},children:tokenMetadata.name}),(errors===null||errors===void 0?void 0:errors.tokenAddress)&&touched.tokenAddress?(0,jsx_runtime_1.jsx)(ErrorText,{children:errors.tokenAddress}):null]}),(0,jsx_runtime_1.jsx)(AvatarCommunityContainer,{container:true,direction:'column',style:{gap:30},item:true,xs:12,md:6,lg:3,children:(0,jsx_runtime_1.jsx)(AvatarContainer,{container:true,item:true,children:(0,jsx_runtime_1.jsx)(UploadAvatar_1.UploadAvatar,{url:values.picUri,setFieldValue:setFieldValue,disabled:isSubmitting})})}),(0,jsx_runtime_1.jsxs)(CommunityContainerBottom,{container:true,justifyContent:'space-between',spacing:isMobileSmall?4:1,children:[(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,container:true,xs:12,md:4,children:(0,jsx_runtime_1.jsx)(CustomInputContainer,{children:(0,jsx_runtime_1.jsx)(formik_1.Field,{name:'symbol',type:'text',placeholder:'Token Symbol',component:CustomFormikTextField})})}),(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,container:true,xs:12,md:4,children:(0,jsx_runtime_1.jsx)(CustomInputContainer,{children:(0,jsx_runtime_1.jsx)(formik_1.Field,{name:'tokenID',type:'text',placeholder:'Token ID',InputProps:{endAdornment:(0,jsx_runtime_1.jsx)(core_1.InputAdornment,{position:'start',children:(0,jsx_runtime_1.jsx)(core_1.Tooltip,{placement:'bottom',title:'Homebase will only track your governance token at a certain ID index, which is a parameter specified upon deploying the token contract. Fungible tokens usually have the ID of 0 (zero).',children:(0,jsx_runtime_1.jsx)(InfoIconInput,{})})})},component:CustomFormikTextField})})}),(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,container:true,xs:12,md:4,children:(0,jsx_runtime_1.jsx)(CustomInputContainer,{children:(0,jsx_runtime_1.jsx)(formik_1.Field,{name:'tokenType',children:()=>(0,jsx_runtime_1.jsxs)(CustomSelect,{disabled:isSubmitting,as:'select',name:(0,formik_1.getIn)(values,'tokenType'),label:'Token Standard',onChange:newValue=>{setFieldValue('tokenType',newValue.target.value);},children:[(0,jsx_runtime_1.jsx)('option',{value:'fa2',children:'FA2'}),(0,jsx_runtime_1.jsx)('option',{value:'nft',children:'NFT'})]})})})})]}),(0,jsx_runtime_1.jsxs)(CommunityContainerBottom,{container:true,direction:'column',children:[(0,jsx_runtime_1.jsxs)(core_1.Grid,{container:true,direction:'row',alignItems:'center',children:[(0,jsx_runtime_1.jsx)(CheckboxContainer,{item:true,xs:2,children:(0,jsx_runtime_1.jsx)(formik_1.Field,{name:'requiredTokenOwnership',children:()=>(0,jsx_runtime_1.jsx)(core_1.Checkbox,{disableRipple:true,checked:values.requiredTokenOwnership,value:(0,formik_1.getIn)(values,'requiredTokenOwnership'),inputProps:{'aria-label':'Checkbox A'},onChange:()=>{setFieldValue('requiredTokenOwnership',!values.requiredTokenOwnership);}})})}),(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,xs:true,children:(0,jsx_runtime_1.jsx)(core_1.Typography,{color:'textSecondary',children:'Require token ownership to create proposals'})})]}),(0,jsx_runtime_1.jsxs)(core_1.Grid,{container:true,direction:'row',alignItems:'center',children:[(0,jsx_runtime_1.jsx)(CheckboxContainer,{item:true,xs:2,children:(0,jsx_runtime_1.jsx)(formik_1.Field,{name:'allowPublicAccess',children:()=>(0,jsx_runtime_1.jsx)(core_1.Checkbox,{disableRipple:true,checked:values.allowPublicAccess,value:(0,formik_1.getIn)(values,'allowPublicAccess'),inputProps:{'aria-label':'Checkbox B'},onChange:()=>{setFieldValue('allowPublicAccess',!values.allowPublicAccess);}})})}),(0,jsx_runtime_1.jsx)(core_1.Grid,{item:true,xs:true,children:(0,jsx_runtime_1.jsx)(core_1.Typography,{color:'textSecondary',children:'Allow public read access to this community'})})]})]}),(0,jsx_runtime_1.jsx)(CommunityContainerBottom,{container:true,direction:'row',children:isSubmitting?(0,jsx_runtime_1.jsx)(core_1.CircularProgress,{color:'secondary'}):(0,jsx_runtime_1.jsx)(SmallButton_1.SmallButton,{variant:'contained',color:'secondary',onClick:()=>submitForm(values),children:'Create Community'})})]})]});};const CommunityCreator=()=>{const navigate=(0,react_router_1.useHistory)();const {network,account,wallet}=(0,useTezos_1.useTezos)();const openNotification=(0,useNotification_1.useNotification)();const initialState={_id:'',name:'',description:'',linkToTerms:'',picUri:'',members:[],polls:[],tokenAddress:'',symbol:'',tokenID:'',tokenType:'FA2',requiredTokenOwnership:false,allowPublicAccess:false,network};const saveCommunity=(0,react_1.useCallback)(values=>__awaiter(void 0,void 0,void 0,function*(){var _a;if(!wallet){return;}values.members.push(account);try{const {signature,payloadBytes}=yield(0,utils_2.getSignature)(account,wallet,JSON.stringify(values));const publicKey=(_a=yield wallet===null||wallet===void 0?void 0:wallet.client.getActiveAccount())===null||_a===void 0?void 0:_a.publicKey;if(!signature){openNotification({message:`Issue with Signature`,autoHideDuration:3000,variant:'error'});return;}const resp=yield(0,lite_services_1.saveLiteCommunity)(signature,publicKey,payloadBytes);if(resp.ok){openNotification({message:'Community created!',autoHideDuration:3000,variant:'success'});navigate.push('/explorer');}else{openNotification({message:'Community could not be created!',autoHideDuration:3000,variant:'error'});return;}}catch(error){openNotification({message:'Community could not be created!',autoHideDuration:3000,variant:'error'});return;}}),[navigate]);return(0,jsx_runtime_1.jsx)(PageContainer,{children:(0,jsx_runtime_1.jsx)(formik_1.Formik,{enableReinitialize:true,validateOnChange:true,validateOnBlur:false,validate:validateForm,onSubmit:saveCommunity,initialValues:initialState,children:({submitForm,isSubmitting,setFieldValue,values,errors,touched,setFieldTouched})=>{return(0,jsx_runtime_1.jsx)(formik_1.Form,{style:{width:'100%'},children:(0,jsx_runtime_1.jsx)(CommunityForm,{submitForm:submitForm,isSubmitting:isSubmitting,setFieldValue:setFieldValue,errors:errors,touched:touched,values:values,setFieldTouched:setFieldTouched})});}})});};exports.CommunityCreator=CommunityCreator;